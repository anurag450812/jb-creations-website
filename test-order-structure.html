<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Structure Test - Xidlz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .console-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Order Structure Test</h1>
        <p>This page tests the order structure and image handling for Xidlz.</p>
        
        <div class="test-section">
            <h3>Firebase API Test</h3>
            <button onclick="testFirebaseConnection()">Test Firebase Connection</button>
            <button onclick="testOrderCreation()" style="background-color: #dc3545; border-color: #dc3545;" title="DISABLED: Use proper Cloudinary workflow instead!">‚ö†Ô∏è Create Test Order (DISABLED)</button>
            <button onclick="viewExistingOrders()">View Existing Orders</button>
        </div>

        <div class="test-section">
            <h3>Image Structure Test</h3>
            <button onclick="testImageStructure()">Test Image Data Structure</button>
            <button onclick="simulateCheckout()">Simulate Checkout Process</button>
        </div>
        
        <div class="test-section">
            <h3>Console Output</h3>
            <div id="consoleOutput" class="console-output">
                Ready for testing...
            </div>
            <button onclick="clearConsole()">Clear Console</button>
        </div>
    </div>

    <!-- Load Firebase client -->
    <script type="module" src="firebase-client.js"></script>

    <script type="module">
        import { JBCreationsAPI } from './firebase-client.js';
        
        // Initialize API
        let jbApi = null;
        
        try {
            jbApi = new JBCreationsAPI();
            log('‚úÖ Firebase API initialized', 'success');
        } catch (error) {
            log('‚ùå Firebase API initialization failed: ' + error.message, 'error');
        }

        // Logging function
        function log(message, type = 'info') {
            const output = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        // Make functions globally available
        window.testFirebaseConnection = async function() {
            log('üîÑ Testing Firebase connection...', 'info');
            
            if (!jbApi) {
                log('‚ùå Firebase API not available', 'error');
                return;
            }
            
            try {
                // Test by attempting to fetch orders
                const result = await jbApi.getAllOrders();
                if (result.success) {
                    log(`‚úÖ Firebase connected successfully. Found ${result.orders.length} orders`, 'success');
                } else {
                    log('‚ùå Firebase connection test failed: ' + result.error, 'error');
                }
            } catch (error) {
                log('‚ùå Firebase connection error: ' + error.message, 'error');
            }
        };

        window.testOrderCreation = async function() {
            log('‚ö†Ô∏è Test order creation is DISABLED for production safety', 'error');
            log('‚ùå This function was creating orders with usingCloudinary: false', 'error');
            log('‚ÑπÔ∏è Use test-cloudinary-flow.html for proper testing instead', 'info');
            return;
            
            // DISABLED CODE - DO NOT REMOVE FOR REFERENCE
            /*
            log('üîÑ Creating test order...', 'info');
            
            if (!jbApi) {
                log('‚ùå Firebase API not available', 'error');
                return;
            }

            // Create a test order with the new structure - THIS WAS PROBLEMATIC
            const testOrderData = {
                orderNumber: `TEST_${Date.now()}`,
                customer: {
                    name: 'Test Customer',
                    email: 'test@example.com',
                    phone: '+91 9999999999',
                    address: 'Test Address, Test City, Test State - 123456'
                },
                items: [{
                    frameSize: { size: '13x19', orientation: 'Portrait' },
                    frameColor: 'black',
                    frameTexture: 'Standard',
                    price: 349,
                    adjustments: {
                        brightness: 100,
                        contrast: 100,
                        highlights: 100,
                        shadows: 100,
                        vibrance: 100
                    },
                    zoom: 1,
                    originalImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    printImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    displayImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }],
                images: [{
                    originalImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    printImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    displayImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }],
                totals: { total: 349 },
                totalAmount: 349,
                deliveryMethod: 'standard',
                usingCloudinary: false, // THIS WAS THE PROBLEM!
                specialInstructions: 'Test order - Frame: 13x19 black Standard'
            };

            log('üìã Test order structure:', 'info');
            log(JSON.stringify(testOrderData, null, 2), 'info');

            try {
                const result = await jbApi.createOrder(testOrderData);
                if (result.success) {
                    log(`‚úÖ Test order created successfully! Order ID: ${result.orderId}`, 'success');
                    log(`üìã Order Number: ${result.orderNumber}`, 'success');
                } else {
                    log('‚ùå Test order creation failed: ' + result.error, 'error');
                }
            } catch (error) {
                log('‚ùå Order creation error: ' + error.message, 'error');
            }
            */
        };

        window.viewExistingOrders = async function() {
            log('üîÑ Fetching existing orders...', 'info');
            
            if (!jbApi) {
                log('‚ùå Firebase API not available', 'error');
                return;
            }

            try {
                const result = await jbApi.getAllOrders();
                if (result.success) {
                    log(`‚úÖ Found ${result.orders.length} orders`, 'success');
                    
                    result.orders.forEach((order, index) => {
                        log(`\nüìã Order ${index + 1}:`, 'info');
                        log(`- ID: ${order.id}`, 'info');
                        log(`- Number: ${order.orderNumber || order.id}`, 'info');
                        log(`- Customer: ${order.customer?.name || order.customerName}`, 'info');
                        log(`- Items: ${order.items?.length || 0}`, 'info');
                        log(`- Images: ${order.images?.length || 0}`, 'info');
                        
                        if (order.items && order.items.length > 0) {
                            const firstItem = order.items[0];
                            log(`- First Item Images:`, 'info');
                            log(`  - Original: ${firstItem.originalImagePath ? '‚úÖ Present' : '‚ùå Missing'}`, firstItem.originalImagePath ? 'success' : 'error');
                            log(`  - Print: ${firstItem.printImagePath ? '‚úÖ Present' : '‚ùå Missing'}`, firstItem.printImagePath ? 'success' : 'error');
                            log(`  - Display: ${firstItem.displayImagePath ? '‚úÖ Present' : '‚ùå Missing'}`, firstItem.displayImagePath ? 'success' : 'error');
                        }
                    });
                } else {
                    log('‚ùå Failed to fetch orders: ' + result.error, 'error');
                }
            } catch (error) {
                log('‚ùå Error fetching orders: ' + error.message, 'error');
            }
        };

        window.testImageStructure = function() {
            log('üîÑ Testing image data structure...', 'info');
            
            // Simulate cart data from sessionStorage
            const mockCartData = [{
                id: Date.now(),
                frameSize: { size: '13x19', orientation: 'Portrait' },
                frameColor: 'black',
                frameTexture: 'Standard',
                price: 349,
                adjustments: {
                    brightness: 100,
                    contrast: 100,
                    highlights: 100,
                    shadows: 100,
                    vibrance: 100
                },
                zoom: 1,
                originalImage: 'data:image/png;base64,test-original',
                printImage: 'data:image/png;base64,test-print',
                displayImage: 'data:image/png;base64,test-display',
                previewImage: 'data:image/png;base64,test-preview'
            }];

            log('üìã Mock cart item structure:', 'info');
            log(JSON.stringify(mockCartData[0], null, 2), 'info');

            // Test how this would be processed for Firebase
            log('üîÑ Processing for Firebase format...', 'info');
            
            const firebaseFormat = {
                items: mockCartData.map(item => ({
                    frameSize: item.frameSize,
                    frameColor: item.frameColor,
                    frameTexture: item.frameTexture,
                    price: item.price,
                    adjustments: item.adjustments,
                    zoom: item.zoom,
                    originalImagePath: item.originalImage,
                    printImagePath: item.printImage,
                    displayImagePath: item.displayImage || item.previewImage
                })),
                images: mockCartData.map(item => ({
                    originalImage: item.originalImage,
                    printImage: item.printImage,
                    displayImage: item.displayImage || item.previewImage
                }))
            };

            log('‚úÖ Firebase format:', 'success');
            log(JSON.stringify(firebaseFormat, null, 2), 'info');
        };

        window.simulateCheckout = async function() {
            log('üîÑ Simulating checkout process...', 'info');
            
            // This simulates what happens in checkout.js
            const orderData = {
                customer: {
                    name: 'Checkout Test User',
                    email: 'checkout@test.com',
                    phone: '+91 8888888888',
                    address: 'Checkout Test Address'
                },
                items: [{
                    frameSize: { size: '13x19', orientation: 'Portrait' },
                    frameColor: 'black',
                    frameTexture: 'Standard',
                    price: 349,
                    adjustments: {
                        brightness: 100,
                        contrast: 100,
                        highlights: 100,
                        shadows: 100,
                        vibrance: 100
                    },
                    zoom: 1,
                    originalImage: 'data:image/png;base64,checkout-original',
                    printImage: 'data:image/png;base64,checkout-print',
                    displayImage: 'data:image/png;base64,checkout-display'
                }],
                totals: { total: 349 },
                deliveryMethod: 'standard'
            };

            log('üì§ Checkout order data:', 'info');
            log(JSON.stringify(orderData, null, 2), 'info');

            try {
                log('üîÑ Submitting simulated checkout order...', 'info');
                const result = await jbApi.createOrder({
                    ...orderData,
                    totalAmount: orderData.totals.total,
                    orderNumber: `CHECKOUT_${Date.now()}`,
                    images: orderData.items.map(item => ({
                        originalImage: item.originalImage,
                        printImage: item.printImage,
                        displayImage: item.displayImage
                    })),
                    specialInstructions: orderData.items.map(item => 
                        `Frame: ${item.frameSize?.size} ${item.frameColor} ${item.frameTexture}`
                    ).join('; ')
                });

                if (result.success) {
                    log(`‚úÖ Checkout simulation successful! Order: ${result.orderNumber}`, 'success');
                } else {
                    log('‚ùå Checkout simulation failed: ' + result.error, 'error');
                }
            } catch (error) {
                log('‚ùå Checkout simulation error: ' + error.message, 'error');
            }
        };

        window.clearConsole = function() {
            document.getElementById('consoleOutput').innerHTML = 'Console cleared...\n';
        };

        // Auto-test on page load
        window.addEventListener('load', function() {
            log('üöÄ Order Structure Test Page Loaded', 'success');
            log('Click the buttons above to run tests', 'info');
        });
    </script>
</body>
</html>