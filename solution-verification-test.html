<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solution Verification Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { border: 1px solid #ddd; margin: 15px 0; padding: 20px; border-radius: 8px; }
        .test-section h3 { margin-top: 0; color: #333; }
        .success { color: #28a745; background-color: #d4edda; border-color: #c3e6cb; }
        .error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { color: #856404; background-color: #fff3cd; border-color: #ffeaa7; }
        .info { color: #004085; background-color: #d1ecf1; border-color: #bee5eb; }
        button { 
            padding: 10px 20px; margin: 10px 5px; border: none; 
            border-radius: 5px; cursor: pointer; font-size: 14px; 
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .console-output { 
            background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; 
            margin: 10px 0; font-family: monospace; white-space: pre-wrap; 
            max-height: 400px; overflow-y: auto; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Solution Verification Test</h1>
        <p>This page verifies that the image display issue has been properly resolved.</p>
        
        <div class="test-section info">
            <h3>üîç Test Plan</h3>
            <p>This verification will test:</p>
            <ul>
                <li>‚úÖ Test pages no longer create problematic orders</li>
                <li>‚úÖ Firebase validation blocks test orders without images</li>
                <li>‚úÖ Cloudinary workflow still works properly</li>
                <li>‚úÖ Admin panel can display Cloudinary images</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>üö´ Test 1: Verify Test Order Blocking</h3>
            <p>Try to create a test order without images (should be blocked):</p>
            <button onclick="testOrderBlocking()" class="btn-danger">Test Order Creation (Should Fail)</button>
            <div id="test1-result"></div>
        </div>
        
        <div class="test-section">
            <h3>‚òÅÔ∏è Test 2: Verify Cloudinary Integration</h3>
            <p>Test that Cloudinary integration still works:</p>
            <button onclick="testCloudinaryIntegration()" class="btn-success">Test Cloudinary Flow</button>
            <div id="test2-result"></div>
        </div>
        
        <div class="test-section">
            <h3>üìã Test 3: Check Existing Orders</h3>
            <p>Check if problematic orders are identified:</p>
            <button onclick="checkExistingOrders()" class="btn-primary">Analyze Existing Orders</button>
            <div id="test3-result"></div>
        </div>
        
        <div class="console-output" id="console-output">
            Verification ready - click any test button to begin...\n
        </div>
    </div>

    <!-- Load Firebase client -->
    <script type="module" src="firebase-client.js"></script>

    <script type="module">
        import { JBCreationsAPI } from './firebase-client.js';
        
        let jbApi = null;
        
        try {
            jbApi = new JBCreationsAPI();
            log('‚úÖ Firebase API initialized for verification');
        } catch (error) {
            log('‚ùå Firebase API initialization failed: ' + error.message);
        }

        function log(message, type = 'info') {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        // Test 1: Verify that test orders without images are blocked
        window.testOrderBlocking = async function() {
            log('üß™ TEST 1: Attempting to create test order without images...', 'info');
            
            const resultDiv = document.getElementById('test1-result');
            
            if (!jbApi) {
                log('‚ùå Firebase API not available', 'error');
                resultDiv.innerHTML = '<div class="error">‚ùå Firebase API not available</div>';
                return;
            }

            // Try to create a problematic test order
            const testOrderData = {
                customer: {
                    name: 'Test Customer Verification',
                    email: 'test@verification.com',
                    phone: '1234567890',
                    address: 'Test Address'
                },
                images: [], // Empty - should be blocked
                totalAmount: 299
            };

            try {
                const result = await jbApi.createOrder(testOrderData);
                
                if (result.success) {
                    log('‚ùå TEST 1 FAILED: Test order was allowed to be created!', 'error');
                    resultDiv.innerHTML = '<div class="error">‚ùå FAILED: Order creation was not blocked</div>';
                } else if (result.blocked) {
                    log('‚úÖ TEST 1 PASSED: Test order was properly blocked', 'success');
                    log(`   Block reason: ${result.error}`, 'info');
                    resultDiv.innerHTML = '<div class="success">‚úÖ PASSED: Test order creation blocked correctly</div>';
                } else {
                    log('‚ö†Ô∏è TEST 1 PARTIAL: Order failed but not due to blocking', 'warning');
                    log(`   Failure reason: ${result.error}`, 'info');
                    resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è PARTIAL: Order failed for other reasons</div>';
                }
            } catch (error) {
                log('‚ùå TEST 1 ERROR: ' + error.message, 'error');
                resultDiv.innerHTML = '<div class="error">‚ùå ERROR: ' + error.message + '</div>';
            }
        };

        // Test 2: Verify Cloudinary integration still works
        window.testCloudinaryIntegration = async function() {
            log('‚òÅÔ∏è TEST 2: Testing Cloudinary integration...', 'info');
            
            const resultDiv = document.getElementById('test2-result');
            
            // Check if backend server is running
            try {
                const response = await fetch('http://localhost:3001/api/health');
                if (response.ok) {
                    const health = await response.json();
                    log('‚úÖ Cloudinary backend server is running', 'success');
                    log(`   Status: ${health.status}`, 'info');
                    resultDiv.innerHTML = '<div class="success">‚úÖ PASSED: Cloudinary backend is operational</div>';
                } else {
                    log('‚ö†Ô∏è Cloudinary backend server returned error', 'warning');
                    resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è WARNING: Backend responded with error</div>';
                }
            } catch (error) {
                log('‚ùå TEST 2: Cloudinary backend server not accessible', 'error');
                log(`   Make sure to run: npm run dev in order-backend folder`, 'info');
                resultDiv.innerHTML = '<div class="error">‚ùå FAILED: Backend server not running</div>';
            }
        };

        // Test 3: Check existing orders for problems
        window.checkExistingOrders = async function() {
            log('üìã TEST 3: Checking existing orders...', 'info');
            
            const resultDiv = document.getElementById('test3-result');
            
            if (!jbApi) {
                log('‚ùå Firebase API not available', 'error');
                resultDiv.innerHTML = '<div class="error">‚ùå Firebase API not available</div>';
                return;
            }

            try {
                const result = await jbApi.getAllOrders();
                
                if (!result.success) {
                    log('‚ùå Failed to load orders: ' + result.error, 'error');
                    resultDiv.innerHTML = '<div class="error">‚ùå Failed to load orders</div>';
                    return;
                }

                const orders = result.orders || [];
                log(`üìä Total orders found: ${orders.length}`, 'info');

                let problematicCount = 0;
                let cloudinaryCount = 0;
                
                orders.forEach(order => {
                    const hasImages = (order.images && order.images.length > 0) ||
                                     (order.items && order.items.some(item => 
                                         item.originalImagePath || item.displayImagePath || item.printImagePath
                                     ));
                    
                    if (!hasImages) {
                        problematicCount++;
                        log(`‚ö†Ô∏è Found problematic order: ${order.id || order.orderNumber}`, 'warning');
                    }
                    
                    if (order.usingCloudinary) {
                        cloudinaryCount++;
                    }
                });

                log(`‚ö†Ô∏è Problematic orders: ${problematicCount}`, 'warning');
                log(`‚òÅÔ∏è Orders using Cloudinary: ${cloudinaryCount}`, 'info');

                let statusClass = 'info';
                let statusText = 'Analysis complete';
                
                if (problematicCount === 0) {
                    statusClass = 'success';
                    statusText = '‚úÖ PASSED: No problematic orders found';
                } else if (problematicCount <= 2) {
                    statusClass = 'warning';
                    statusText = `‚ö†Ô∏è PARTIAL: ${problematicCount} legacy problematic orders (likely test orders)`;
                } else {
                    statusClass = 'error';
                    statusText = `‚ùå FAILED: ${problematicCount} problematic orders found`;
                }

                resultDiv.innerHTML = `<div class="${statusClass}">${statusText}</div>`;

            } catch (error) {
                log('‚ùå TEST 3 ERROR: ' + error.message, 'error');
                resultDiv.innerHTML = '<div class="error">‚ùå ERROR: ' + error.message + '</div>';
            }
        };

    </script>
</body>
</html>