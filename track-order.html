<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Order - Xidlz</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .track-section {
            background: #FFFFFF;
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.15);
            border: 1px solid rgba(255, 107, 107, 0.1);
        }

        .section-title {
            font-size: 28px;
            margin-bottom: 25px;
            color: #16697A;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }

        .track-form {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #16697A;
        }

        .track-btn {
            background: #16697A;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
            align-self: end;
        }

        .track-btn:hover {
            background: #0f5a6a;
        }

        .track-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .order-result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .order-result.success {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .order-result.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .detail-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .detail-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #2c3e50;
            font-size: 16px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.processing {
            background: #cce5ff;
            color: #004085;
        }

        .status-badge.shipped {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.delivered {
            background: #d4edda;
            color: #155724;
        }

        .guest-info {
            background: #e2f3ff;
            border: 1px solid #b8e2ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .guest-info h3 {
            margin: 0 0 15px 0;
            color: #16697A;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .guest-info ul {
            margin: 0;
            padding-left: 20px;
        }

        .guest-info li {
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .recent-orders {
            margin-top: 30px;
        }

        .recent-order {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recent-order-info {
            flex: 1;
        }

        .recent-order-number {
            font-weight: 600;
            color: #16697A;
        }

        .recent-order-date {
            color: #6c757d;
            font-size: 14px;
        }

        .recent-order-amount {
            font-weight: 600;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .track-form {
                flex-direction: column;
            }

            .order-details {
                grid-template-columns: 1fr;
            }

            .recent-order {
                flex-direction: column;
                align-items: start;
                gap: 10px;
            }
        }

        /* Header and Dropdown Styles - Matching Homepage */
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .auth-section {
            display: flex;
            align-items: center;
        }

        /* Profile Dropdown Styles are now centralized in style.css */


        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .site-header {
                position: relative !important;
                top: auto;
                margin-bottom: 0;
                background: var(--background-color);
                padding: 10px 0;
                box-shadow: none;
                border-radius: 0;
                z-index: 2500;
            }

            .header-content {
                background: transparent;
                border-radius: 0;
                padding: 0 1rem;
                border: none;
                box-shadow: none;
                gap: 0.75rem;
            }

            .header-right {
                gap: 10px;
            }

            .profile-icon-btn,
            .cart-icon-btn {
                background: transparent;
                border: none;
                border-radius: 0;
                padding: 6px;
                box-shadow: none;
                color: #16697A;
            }

            .profile-icon-btn {
                font-size: 20px;
                min-width: 40px;
                gap: 2px;
            }

            .profile-icon-btn i {
                font-size: 16px;
            }

            .profile-icon-btn:hover,
            .cart-icon-btn:hover {
                background: transparent;
                color: #0f4f5d;
                border: none;
                box-shadow: none;
            }

            .profile-icon-btn .button-label,
            .cart-icon-btn .button-label {
                font-size: 0.62rem;
                letter-spacing: 0.4px;
            }

            body {
                padding-top: 0;
            }
        }

        @media (max-width: 480px) {
            .site-header {
                padding: 10px 0;
            }

            .header-content {
                padding: 0 0.85rem;
                gap: 0.55rem;
            }

            .brand-name {
                font-size: 1.65rem;
                letter-spacing: 1px;
            }

            .profile-icon-btn,
            .cart-icon-btn {
                padding: 6px 9px;
            }
        }
    </style>
    <!-- Global Header Component -->
    <script src="global-header.js"></script>
</head>
<body>
    <!-- GlobalWebsiteHeader Component Container -->
    <div id="global-header-container"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            GlobalWebsiteHeader.init();
        });
    </script>

    <div class="container">
        <!-- Guest Order Tracking Info -->
        <div class="guest-info">
            <h3>
                <i class="fas fa-info-circle"></i>
                Guest Order Tracking
            </h3>
            <ul>
                <li>Track your order using your order number and email address</li>
                <li>Order numbers start with "JB" followed by 9 digits (e.g., JB123456789)</li>
                <li>You received this information via email after placing your order</li>
                <li>Recent guest orders (last 10) are shown below if available</li>
            </ul>
        </div>

        <!-- Order Tracking Section -->
        <div class="track-section">
            <h2 class="section-title">
                <i class="fas fa-search"></i>
                Track Your Order
            </h2>

            <form class="track-form" onsubmit="trackOrder(event)">
                <div class="form-group">
                    <label for="orderNumber">Order Number</label>
                    <input type="text" id="orderNumber" placeholder="JB123456789" required>
                </div>
                <div class="form-group">
                    <label for="emailAddress">Email Address</label>
                    <input type="email" id="emailAddress" placeholder="your.email@example.com" required>
                </div>
                <button type="submit" class="track-btn" id="trackBtn">
                    <i class="fas fa-search"></i> Track Order
                </button>
            </form>

            <div id="trackingResult"></div>
        </div>

        <!-- Recent Guest Orders -->
        <div class="track-section">
            <h2 class="section-title">
                <i class="fas fa-history"></i>
                Recent Guest Orders
            </h2>
            <div id="recentOrders"></div>
        </div>
    </div>

    <script>
        function setProfileDropdownState(isOpen) {
            const dropdownContainer = document.getElementById('profileDropdown');
            const dropdownMenu = document.getElementById('profileDropdownMenu');
            const profileBtn = document.getElementById('profileBtn');

            if (!dropdownContainer || !dropdownMenu || !profileBtn) {
                return;
            }

            dropdownContainer.classList.toggle('open', isOpen);
            profileBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            dropdownMenu.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
        }

        function toggleProfileDropdown() {
            const dropdownContainer = document.getElementById('profileDropdown');
            if (!dropdownContainer) {
                return;
            }

            const isOpen = dropdownContainer.classList.contains('open');
            setProfileDropdownState(!isOpen);
        }

        function setupProfileDropdown() {
            const dropdownContainer = document.getElementById('profileDropdown');
            const dropdownMenu = document.getElementById('profileDropdownMenu');
            const profileBtn = document.getElementById('profileBtn');

            if (!dropdownContainer || !dropdownMenu || !profileBtn || dropdownContainer.dataset.dropdownInit === 'true') {
                return;
            }

            dropdownContainer.dataset.dropdownInit = 'true';

            profileBtn.setAttribute('aria-haspopup', 'true');
            profileBtn.setAttribute('aria-expanded', 'false');
            dropdownMenu.setAttribute('role', 'menu');
            dropdownMenu.setAttribute('aria-hidden', 'true');

            profileBtn.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                toggleProfileDropdown();
            });

            dropdownMenu.addEventListener('click', function(event) {
                const actionableItem = event.target.closest('a, button');
                if (actionableItem && actionableItem.dataset.closeDropdown === 'true') {
                    setProfileDropdownState(false);
                }
            });

            setProfileDropdownState(false);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupProfileDropdown();
            loadRecentGuestOrders();
        });

        // Track order function
        function trackOrder(event) {
            event.preventDefault();
            
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const emailAddress = document.getElementById('emailAddress').value.trim();
            const resultDiv = document.getElementById('trackingResult');
            const trackBtn = document.getElementById('trackBtn');
            
            // Show loading state
            trackBtn.disabled = true;
            trackBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
            
            // Simulate API call delay
            setTimeout(() => {
                try {
                    // Search in guest orders
                    const guestOrders = JSON.parse(localStorage.getItem('jb_guest_orders') || '[]');
                    const order = guestOrders.find(o => 
                        o.orderNumber === orderNumber && 
                        o.customerEmail.toLowerCase() === emailAddress.toLowerCase()
                    );
                    
                    if (order) {
                        showOrderDetails(order, resultDiv);
                    } else {
                        showOrderNotFound(resultDiv, orderNumber);
                    }
                } catch (error) {
                    showTrackingError(resultDiv, error.message);
                }
                
                // Reset button
                trackBtn.disabled = false;
                trackBtn.innerHTML = '<i class="fas fa-search"></i> Track Order';
            }, 1000);
        }

        // Show order details
        function showOrderDetails(order, container) {
            container.innerHTML = `
                <div class="order-result success">
                    <h3><i class="fas fa-check-circle"></i> Order Found</h3>
                    <div class="order-details">
                        <div class="detail-item">
                            <div class="detail-label">Order Number</div>
                            <div class="detail-value">${order.orderNumber}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status-badge ${order.status}">${order.status}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Order Date</div>
                            <div class="detail-value">${new Date(order.orderDate).toLocaleDateString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Amount</div>
                            <div class="detail-value">‚Çπ${order.total}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Items</div>
                            <div class="detail-value">${order.itemCount} item(s)</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Delivery Method</div>
                            <div class="detail-value">${order.deliveryMethod === 'express' ? 'Express (2-3 days)' : 'Standard (5-7 days)'}</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                        <strong>Next Steps:</strong>
                        <ul style="margin: 10px 0 0 20px;">
                            <li>We will send you email updates about your order status</li>
                            <li>For urgent inquiries, contact us with your order number</li>
                            <li>Estimated delivery: ${getEstimatedDelivery(order)}</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Show order not found
        function showOrderNotFound(container, orderNumber) {
            container.innerHTML = `
                <div class="order-result error">
                    <h3><i class="fas fa-exclamation-triangle"></i> Order Not Found</h3>
                    <p>We couldn't find an order with number <strong>${orderNumber}</strong> for the provided email address.</p>
                    <div style="margin-top: 15px;">
                        <strong>Please check:</strong>
                        <ul style="margin: 10px 0 0 20px;">
                            <li>Order number is correct (should start with "JB")</li>
                            <li>Email address matches the one used during checkout</li>
                            <li>Order was placed as a guest (not with a registered account)</li>
                        </ul>
                    </div>
                    <p style="margin-top: 15px;">
                        <strong>Need help?</strong> Contact us with your order details for assistance.
                    </p>
                </div>
            `;
        }

        // Show tracking error
        function showTrackingError(container, message) {
            container.innerHTML = `
                <div class="order-result error">
                    <h3><i class="fas fa-exclamation-triangle"></i> Tracking Error</h3>
                    <p>Sorry, there was an error looking up your order: ${message}</p>
                    <p>Please try again or contact us for assistance.</p>
                </div>
            `;
        }

        // Get estimated delivery date
        function getEstimatedDelivery(order) {
            const orderDate = new Date(order.orderDate);
            const deliveryDays = order.deliveryMethod === 'express' ? 3 : 7;
            const estimatedDate = new Date(orderDate);
            estimatedDate.setDate(orderDate.getDate() + deliveryDays);
            return estimatedDate.toLocaleDateString();
        }

        // Load recent guest orders
        function loadRecentGuestOrders() {
            const container = document.getElementById('recentOrders');
            
            try {
                const guestOrders = JSON.parse(localStorage.getItem('jb_guest_orders') || '[]');
                
                if (guestOrders.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>No recent guest orders found on this device.</p>
                            <p><small>Guest orders are stored locally on your device.</small></p>
                        </div>
                    `;
                    return;
                }
                
                // Sort by date (newest first)
                guestOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
                
                let ordersHTML = '';
                guestOrders.forEach(order => {
                    ordersHTML += `
                        <div class="recent-order">
                            <div class="recent-order-info">
                                <div class="recent-order-number">${order.orderNumber}</div>
                                <div class="recent-order-date">${new Date(order.orderDate).toLocaleDateString()}</div>
                                <div>Customer: ${order.customerName}</div>
                            </div>
                            <div class="recent-order-amount">‚Çπ${order.total}</div>
                            <div>
                                <span class="status-badge ${order.status}">${order.status}</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = ordersHTML;
                
            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading recent orders: ${error.message}
                    </div>
                `;
            }
        }

        // Get current authenticated user from Firebase
        async function getCurrentAuthenticatedUser() {
            try {
                // Wait for Firebase to be ready with retry mechanism
                const maxRetries = 5; // Reduced from 10 since we now have the proper scripts
                for (let i = 0; i < maxRetries; i++) {
                    if (typeof window.otpAuth !== 'undefined') {
                        console.log('üì± Getting current user from Firebase...');
                        const user = await window.otpAuth.getCurrentUser();
                        console.log('üì± Firebase user result:', user);
                        return user;
                    } else {
                        console.log(`‚è≥ Firebase not ready yet, retrying... (${i + 1}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, 300)); // Reduced from 500ms
                    }
                }
                
                console.log('‚ùå OTP Auth system not available after retries, falling back to localStorage');
                // Fallback to localStorage if Firebase is not available after retries
                const userDataStr = localStorage.getItem('jb_current_user');
                if (!userDataStr) return null;
                
                try {
                    return JSON.parse(userDataStr);
                } catch (parseError) {
                    console.log('Failed to parse user data as JSON, might be old format:', userDataStr);
                    if (userDataStr.startsWith('+91') || userDataStr.startsWith('+')) {
                        return { phone: userDataStr, name: 'User' };
                    }
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error getting current user from Firebase:', error);
                return null;
            }
        }

        // Authentication state check
        document.addEventListener('DOMContentLoaded', async function() {
            setupProfileDropdown();
            await checkAuthStatus();
        });

        async function checkAuthStatus() {
            try {
                const user = await getCurrentAuthenticatedUser();
                console.log('üì± checkAuthStatus - user found:', user);
                
                const guestOptions = document.getElementById('guestOptions');
                const authenticatedOptions = document.getElementById('authenticatedOptions');
                
                if (user && user.phone) {
                    console.log('üì± checkAuthStatus - user name:', user.name);
                    console.log('üì± checkAuthStatus - user phone:', user.phone);
                    
                    if (guestOptions) guestOptions.style.display = 'none';
                    if (authenticatedOptions) authenticatedOptions.style.display = 'block';
                    
                    const dropdownUserName = document.getElementById('dropdownUserName');
                    const dropdownUserPhone = document.getElementById('dropdownUserPhone');
                    
                    if (dropdownUserName) {
                        dropdownUserName.textContent = user.name || 'User';
                        console.log('üì± checkAuthStatus - Set dropdown name to:', user.name || 'User');
                    }
                    if (dropdownUserPhone) {
                        dropdownUserPhone.textContent = user.phone || 'Phone not available';
                    }
                } else {
                    showGuestState();
                }
                
                // Also call updateAuthUI for consistency with homepage
                await updateAuthUI();
            } catch (error) {
                console.log('Auth check error:', error);
                showGuestState();
            }
        }

        function showGuestState() {
            const guestOptions = document.getElementById('guestOptions');
            const authenticatedOptions = document.getElementById('authenticatedOptions');
            if (guestOptions) guestOptions.style.display = 'block';
            if (authenticatedOptions) authenticatedOptions.style.display = 'none';
        }

        // Update authentication UI based on login status
        async function updateAuthUI() {
            try {
                const user = await getCurrentAuthenticatedUser();
                console.log('üì± updateAuthUI - user found:', user);
                
                const guestOptions = document.getElementById('guestOptions');
                const authenticatedOptions = document.getElementById('authenticatedOptions');
                const profileBtn = document.getElementById('profileBtn');
                
                if (user) {
                    console.log('üì± updateAuthUI - user name:', user.name);
                    console.log('üì± updateAuthUI - user phone:', user.phone);
                    
                    // User is logged in - show authenticated options, hide guest options
                    if (guestOptions) {
                        guestOptions.style.display = 'none';
                    }
                    if (authenticatedOptions) {
                        authenticatedOptions.style.display = 'block';
                    }
                    
                    // Update user info in dropdown
                    const dropdownUserName = document.getElementById('dropdownUserName');
                    const dropdownUserPhone = document.getElementById('dropdownUserPhone');
                    
                    if (dropdownUserName) {
                        dropdownUserName.textContent = user.name || 'User';
                        console.log('üì± updateAuthUI - Set dropdown name to:', user.name || 'User');
                    }
                    if (dropdownUserPhone) {
                        dropdownUserPhone.textContent = user.phone || 'Phone not available';
                    }
                    
                    // Always keep profile button text as "Profile"
                    if (profileBtn) {
                        profileBtn.innerHTML = `
                            <i class="fas fa-user-alt"></i>
                            <span class="button-label">Profile</span>
                        `;
                        profileBtn.style.color = '#16697A';
                    }
                } else {
                    // User is not logged in - show guest options, hide authenticated options
                    if (guestOptions) {
                        guestOptions.style.display = 'block';
                    }
                    if (authenticatedOptions) {
                        authenticatedOptions.style.display = 'none';
                    }
                    
                    // Reset profile button to default
                    if (profileBtn) {
                        profileBtn.innerHTML = `
                            <i class="fas fa-user-alt"></i>
                            <span class="button-label">Profile</span>
                        `;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error updating auth UI:', error);
            }
        }

        // View user profile / toggle dropdown
        async function viewProfile() {
            window.location.href = 'my-profile.html';
        }

        document.addEventListener('click', function(event) {
            const dropdownContainer = document.getElementById('profileDropdown');
            if (!dropdownContainer) {
                return;
            }

            if (!dropdownContainer.contains(event.target)) {
                setProfileDropdownState(false);
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                setProfileDropdownState(false);
            }
        });

        // View user orders
        function viewOrders() {
            setProfileDropdownState(false);
            window.location.href = 'my-orders.html';
        }

        // Contact us function
        function contactUs() {
            alert('Contact Us\n\nEmail: contact@jbcreations.com\nPhone: +91 12345 67890\nAddress: 123 Art Street, Creative City, India\n\nWe\'d love to hear from you!');
        }

        // About us function
        function aboutUs() {
            alert('About Xidlz\n\nWe are passionate about turning your precious memories into beautiful wall art. With years of experience in custom photo framing, we use premium materials and professional craftsmanship to create frames that last a lifetime.\n\nOur mission is to help you showcase your most cherished moments in style.');
        }

        // Sign out function (for compatibility with other pages)
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                localStorage.removeItem('jb_current_user');
                localStorage.removeItem('jb_users');
                checkAuthStatus();
                alert('You have been signed out successfully.');
            }
        }
    </script>

    <!-- Firebase Backend Integration -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="fast2sms-client.js?v=3.0"></script>
    <script src="otp-auth-realsms.js?v=3.0"></script>
    <script src="firebase-client-new.js?v=3.0"></script>
</body>
</html>
