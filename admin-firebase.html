<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JB Creations - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5b4fc;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            
            /* Neutrals */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Background */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            
            /* Text */
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            
            /* Border */
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Transitions */
            --transition: all 0.2s ease-in-out;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-light);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 2rem;
            height: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1.5rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            padding: 0 0.75rem;
        }

        .nav-items {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: var(--bg-tertiary);
            color: var(--primary);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .nav-icon {
            width: 1.25rem;
            text-align: center;
        }

        .nav-badge {
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 1rem;
            margin-left: auto;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            flex: 1;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 2rem;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .stat-icon.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }

        .stat-icon.success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .stat-icon.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        .stat-icon.info {
            background: linear-gradient(135deg, var(--info), #2563eb);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border-medium);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* Table */
        .table-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--bg-tertiary);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border-light);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }

        .table tbody tr:hover {
            background: var(--bg-secondary);
        }
        
        /* Clickable order rows */
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }
        
        .clickable-row:hover {
            background: #f5f0eb !important;
        }

        /* Status badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Action buttons */
        .action-btns {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            width: 2rem;
            height: 2rem;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: var(--transition);
        }

        .action-btn.view {
            background: #dbeafe;
            color: var(--info);
        }

        .action-btn.edit {
            background: #fef3c7;
            color: var(--warning);
        }

        .action-btn.delete {
            background: #fee2e2;
            color: var(--danger);
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        /* Checkbox styling for order selection */
        .order-checkbox {
            width: 1.125rem;
            height: 1.125rem;
            accent-color: var(--primary);
            cursor: pointer;
            margin: 0;
        }

        .order-checkbox:hover {
            transform: scale(1.1);
        }

        .select-all-checkbox {
            width: 1.125rem;
            height: 1.125rem;
            accent-color: var(--primary);
            cursor: pointer;
            margin: 0;
        }

        /* Bulk actions bar */
        .bulk-actions-bar {
            display: none;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--primary-light), #c7d2fe);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bulk-actions-bar.show {
            display: flex;
        }

        .bulk-actions-bar .selected-count {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .bulk-actions-bar .btn-delete-selected {
            background: var(--danger);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .bulk-actions-bar .btn-delete-selected:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .bulk-actions-bar .btn-clear-selection {
            background: transparent;
            color: var(--primary-dark);
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary-dark);
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .bulk-actions-bar .btn-clear-selection:hover {
            background: rgba(79, 70, 229, 0.1);
        }

        /* Confirmation modal */
        .confirm-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease-out;
        }

        .confirm-modal-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .confirm-modal {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 0.2s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .confirm-modal-icon {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1.5rem;
            background: #fee2e2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--danger);
        }

        .confirm-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .confirm-modal-message {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .confirm-modal-buttons .btn-cancel {
            padding: 0.75rem 1.5rem;
            background: var(--gray-200);
            color: var(--text-secondary);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .confirm-modal-buttons .btn-cancel:hover {
            background: var(--gray-300);
        }

        .confirm-modal-buttons .btn-confirm-delete {
            padding: 0.75rem 1.5rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .confirm-modal-buttons .btn-confirm-delete:hover {
            background: #dc2626;
        }

        /* Order Status Tabs */
        .order-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-light);
        }

        .order-tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }

        .order-tab:hover {
            color: var(--primary);
        }

        .order-tab.active {
            color: var(--primary);
        }

        .order-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .order-tab .tab-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem;
            height: 1.5rem;
            padding: 0 0.5rem;
            margin-left: 0.5rem;
            background: var(--gray-200);
            color: var(--text-secondary);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .order-tab.active .tab-count {
            background: var(--primary);
            color: white;
        }

        /* Pagination Controls */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-top: 1px solid var(--border-light);
            margin-top: 1rem;
        }

        .pagination-info {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pagination-btn {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-medium);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-pages {
            display: flex;
            gap: 0.25rem;
        }

        .page-btn {
            min-width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-medium);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .page-btn:hover {
            background: var(--bg-tertiary);
        }

        .page-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .items-per-page label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .items-per-page select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            width: 2rem;
            height: 2rem;
            border: 2px solid var(--border-light);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Search and Filter */
        .search-filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--bg-primary);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--bg-primary);
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            width: 1200px;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .order-details {
            display: grid;
            gap: 1rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-light);
            gap: 1rem;
            min-height: 2rem;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 150px;
            flex-shrink: 0;
        }

        .detail-value {
            color: var(--text-primary);
            flex: 1;
            word-wrap: break-word;
        }

        /* Order header grid styling */
        .order-header {
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .order-header .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .order-header .detail-row {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
        }

        /* Order item cards */
        .order-item-card {
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: var(--bg-secondary);
        }

        .order-item-card .item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .order-item-card .detail-row {
            background: var(--bg-primary);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
        }

        /* Image grid and cards */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .image-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 15px;
            text-align: center;
            position: relative;
        }

        .image-card img {
            width: 100%;
            height: 250px;
            object-fit: contain;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border-light);
            background: var(--bg-tertiary);
        }

        .image-card.empty {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Download buttons */
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }

        .download-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .download-btn i {
            font-size: 0.9em;
        }

        /* Adjustments section */
        .adjustments-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 20px;
        }

        .adjustments-section .adjustment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            font-size: 0.85em;
        }

        .adjustments-section .adjustment-item {
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            text-align: center;
        }

        /* Mobile Bottom Navigation Bar */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-light);
            z-index: 1000;
            padding: 0.5rem 0.75rem;
            padding-bottom: calc(0.5rem + env(safe-area-inset-bottom, 0));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .mobile-nav-scroll {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 0.25rem 0;
        }
        
        .mobile-nav-scroll::-webkit-scrollbar {
            display: none;
        }
        
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 70px;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
            font-size: 0.6875rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            scroll-snap-align: start;
            transition: var(--transition);
            position: relative;
            flex-shrink: 0;
        }
        
        .mobile-nav-item i {
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }
        
        .mobile-nav-item.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: var(--primary);
        }
        
        .mobile-nav-item:not(.active):hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .mobile-nav-badge {
            position: absolute;
            top: 2px;
            right: 8px;
            background: var(--danger);
            color: white;
            font-size: 0.5625rem;
            font-weight: 600;
            min-width: 14px;
            height: 14px;
            padding: 0 4px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Mobile Select All Bar - hidden on desktop */
        .mobile-select-all-bar {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            /* Prevent horizontal scrolling */
            html, body {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }
            
            /* Show mobile select all bar */
            .mobile-select-all-bar {
                display: block;
                padding: 0.75rem 1rem;
                background: #f8f4f0;
                border-bottom: 1px solid #e0d8d0;
                margin-bottom: 0;
            }
            
            .mobile-select-all-label {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 500;
                color: #333;
            }
            
            .mobile-select-all-label input[type="checkbox"] {
                width: 18px;
                height: 18px;
                accent-color: #8B4513;
            }
            
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding-bottom: 80px; /* Space for bottom nav */
                overflow-x: hidden !important;
            }
            
            .mobile-bottom-nav {
                display: block;
                position: fixed !important;
            }

            .header {
                padding: 1rem;
            }

            .content {
                padding: 1rem;
                padding-bottom: 100px; /* Extra space for bottom nav */
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            /* Mobile Meesho-style List */
            .table-container {
                overflow: hidden !important;
                border: none;
                background: transparent;
            }
            
            .table {
                display: block;
                width: 100%;
            }
            
            .table thead {
                display: none;
            }
            
            .table tbody {
                display: flex;
                flex-direction: column;
                gap: 0;
            }
            
            .table tbody tr {
                display: block;
                background: var(--bg-primary);
                border-bottom: 1px solid var(--border-light);
                padding: 0.75rem 0;
            }
            
            .table tbody tr:hover {
                background: var(--bg-secondary);
            }
            
            .table td {
                display: inline;
                padding: 0;
                border: none;
                font-size: 0.8125rem;
            }
            
            /* Hide data-label completely */
            .table td::before {
                display: none !important;
                content: none !important;
            }
            
            /* Order tabs mobile */
            .order-tabs {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 0.5rem;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .order-tabs::-webkit-scrollbar {
                display: none;
            }
            
            .order-tab {
                flex-shrink: 0;
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
            
            /* Search filter bar mobile */
            .search-filter-bar {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .search-filter-bar .search-input,
            .search-filter-bar .filter-select {
                width: 100%;
            }
            
            /* Bulk actions mobile - horizontal layout */
            .bulk-actions-bar {
                flex-direction: row;
                flex-wrap: nowrap;
                gap: 0.5rem;
                padding: 0.5rem 0.75rem;
                justify-content: center;
                align-items: center;
            }
            
            .bulk-actions-bar .selected-count {
                font-size: 0.8rem;
                white-space: nowrap;
            }
            
            .bulk-actions-bar .btn-delete-selected,
            .bulk-actions-bar .btn-clear-selection {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            /* Pagination mobile - arrows on sides of page numbers */
            .pagination-container {
                flex-direction: column;
                gap: 0.75rem;
                padding: 0.75rem;
            }
            
            .pagination-controls {
                display: flex;
                flex-wrap: nowrap;
                justify-content: center;
                align-items: center;
                gap: 0.5rem;
                width: 100%;
            }
            
            .pagination-controls .items-per-page {
                display: none;
            }
            
            .pagination-btn {
                width: 2rem;
                height: 2rem;
                min-width: 2rem;
            }
            
            .pagination-pages {
                display: flex;
                gap: 0.25rem;
            }
            
            .page-btn {
                min-width: 2rem;
                height: 2rem;
                font-size: 0.75rem;
            }
            
            /* Compact bulk actions bar for mobile */
            .bulk-actions-bar.compact {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                gap: 0.5rem;
            }
            
            .bulk-actions-bar.compact .btn-delete-selected,
            .bulk-actions-bar.compact .btn-clear-selection {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            /* Card header mobile */
            .card-header {
                flex-direction: column;
                gap: 0.75rem;
                align-items: flex-start;
            }
            
            /* Force no horizontal scroll */
            .content, .card, .card-body, #orders-view, #customers-view, #analytics-view {
                overflow-x: hidden !important;
                max-width: 100vw;
            }
            
            /* Analytics charts fix */
            #analytics-view > div[style*="grid-template-columns"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
            }
            
            #analytics-view .card {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            #analytics-view .card canvas {
                max-width: 100% !important;
                height: auto !important;
                max-height: 200px !important;
            }
            
            /* Stat cards more compact on mobile */
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            /* Mobile Order Table - Card Layout */
            .order-row {
                display: flex;
                flex-wrap: wrap;
                padding: 0.75rem 1rem;
                border-bottom: 1px solid #eee;
                gap: 0.5rem;
                align-items: center;
            }
            
            /* Hide the full table header on mobile */
            #all-orders-table thead {
                display: none;
            }
            
            /* Make table display as block */
            #all-orders-table,
            #all-orders-table tbody {
                display: block;
                width: 100%;
            }
            
            /* Column styling for mobile - reorder and show as card */
            .order-row .col-checkbox {
                order: 1;
                width: auto;
                padding: 0;
            }
            
            .order-row .col-order-id {
                order: 2;
                font-size: 0.9rem;
                flex: 1;
            }
            
            .order-row .col-amount {
                order: 3;
                text-align: right;
            }
            
            .order-row .col-customer {
                order: 4;
                width: 100%;
                font-size: 0.85rem;
                color: #333;
            }
            
            .order-row .col-email,
            .order-row .col-phone {
                display: none;
            }
            
            .order-row .col-qty {
                order: 5;
                font-size: 0.75rem;
                color: #666;
            }
            
            .order-row .col-qty::before {
                content: 'Qty: ';
            }
            
            .order-row .col-date {
                order: 6;
                font-size: 0.7rem;
                color: #999;
            }
            
            .order-row .col-status {
                order: 7;
                margin-left: auto;
            }
            
            .order-row .col-status .status-badge {
                font-size: 0.65rem;
                padding: 0.15rem 0.4rem;
            }
            
            .order-row .col-actions {
                order: 8;
                display: flex;
                gap: 0.5rem;
            }
            
            .order-row .col-actions button {
                padding: 0.35rem 0.6rem;
                font-size: 0.7rem;
            }
            
            /* Hide table headers on mobile for compact view */
            #all-customers-table thead,
            #top-customers-table thead {
                display: none;
            }
            
            /* Make customer tables display as block on mobile */
            #all-customers-table,
            #all-customers-table tbody,
            #top-customers-table,
            #top-customers-table tbody {
                display: block;
                width: 100%;
            }
            
            /* Mobile customer row styles */
            .customer-row {
                display: flex;
                flex-wrap: wrap;
                padding: 0.75rem 1rem;
                border-bottom: 1px solid #eee;
                gap: 0.5rem;
                align-items: center;
            }
            
            .customer-row .col-rank {
                order: 1;
                width: auto;
                font-size: 1.1rem;
            }
            
            .customer-row .col-name {
                order: 2;
                flex: 1;
                font-weight: 600;
                font-size: 0.9rem;
            }
            
            .customer-row .col-orders {
                order: 3;
            }
            
            .customer-row .col-email {
                order: 4;
                width: 100%;
                font-size: 0.8rem;
                color: #666;
            }
            
            .customer-row .col-phone {
                order: 5;
                font-size: 0.75rem;
                color: #999;
            }
            
            .customer-row .col-spent {
                order: 6;
                margin-left: auto;
            }
            
            .customer-row .col-type {
                order: 7;
            }
            
            .customer-row .col-type .badge {
                font-size: 0.6rem;
                padding: 0.15rem 0.35rem;
            }
        }

        /* Support Chat Styles - WhatsApp-like Interface */
        .whatsapp-chat-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 140px);
            max-height: 700px;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .chat-list-panel {
            background: var(--bg-primary);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-list-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-list-header h3 {
            margin: 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-list-header h3 i {
            color: var(--primary);
        }
        
        .chat-header-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Chat Category Tabs */
        .chat-category-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }
        
        .chat-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
        }
        
        .chat-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .chat-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--bg-primary);
        }
        
        .tab-badge {
            background: var(--danger);
            color: white;
            font-size: 0.6875rem;
            padding: 0.125rem 0.375rem;
            border-radius: 1rem;
            font-weight: 600;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-list-item {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .chat-list-item:hover {
            background: var(--bg-secondary);
        }

        .chat-list-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(79, 70, 229, 0.1));
            border-left: 3px solid var(--primary);
        }

        .chat-list-item.unread {
            background: rgba(99, 102, 241, 0.05);
        }
        
        .chat-list-item.unread .chat-user-name {
            font-weight: 700;
        }
        
        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .chat-user-info {
            display: flex;
            flex-direction: column;
        }

        .chat-user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        .chat-user-phone {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .chat-time {
            font-size: 0.6875rem;
            color: var(--text-muted);
        }

        .chat-unread-badge {
            background: var(--primary);
            color: white;
            font-size: 0.6875rem;
            font-weight: 600;
            min-width: 18px;
            height: 18px;
            padding: 0 0.375rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-preview {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-status-badge {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .chat-status-open { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .chat-status-pending { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .chat-status-closed { background: rgba(107, 114, 128, 0.15); color: #6b7280; }

        .chat-conversation-panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .no-chat-selected {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            background: var(--bg-secondary);
        }

        .no-chat-selected i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .no-chat-selected h3 {
            margin: 0 0 0.5rem;
            color: var(--text-secondary);
        }
        
        .conversation-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .conversation-header {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-user-info h4 {
            margin: 0;
            font-size: 1rem;
        }

        .conversation-user-info p {
            margin: 0.25rem 0 0;
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .conversation-actions {
            display: flex;
            gap: 0.5rem;
        }

        .conversation-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background: #e5ddd5;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .message-bubble {
            max-width: 65%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.4;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        .message-bubble.user {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }

        .message-bubble.admin {
            background: #dcf8c6;
            color: #111;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }

        .message-bubble .message-time {
            font-size: 0.6875rem;
            opacity: 0.6;
            margin-top: 0.25rem;
            text-align: right;
        }

        .conversation-input {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 0.75rem;
            background: var(--bg-primary);
        }

        .conversation-input input {
            flex: 1;
            padding: 0.625rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 1.5rem;
            font-size: 0.9375rem;
            outline: none;
            transition: var(--transition);
        }

        .conversation-input input:focus {
            border-color: var(--primary);
        }

        .conversation-input button {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .conversation-input button:hover {
            transform: scale(1.05);
        }
        
        /* Mobile Chat Header */
        .mobile-chat-header {
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .mobile-chat-header .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }
        
        .mobile-user-info {
            flex: 1;
        }
        
        .mobile-user-name {
            font-weight: 600;
            display: block;
        }
        
        .mobile-user-phone {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .whatsapp-chat-container {
                display: block;
                height: calc(100vh - 120px);
                max-height: none;
            }
            
            .chat-list-panel {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 10;
                border-right: none;
            }
            
            .chat-list-panel.hidden {
                display: none;
            }
            
            .chat-conversation-panel {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 20;
                display: none;
            }
            
            .chat-conversation-panel.active {
                display: flex;
            }
            
            .mobile-chat-header {
                display: flex !important;
            }
            
            .conversation-header {
                display: none;
            }
            
            .no-chat-selected {
                display: none;
            }
            
            #support-view {
                position: relative;
                height: calc(100vh - 120px);
            }
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .loading-state i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        @media (max-width: 1024px) {
            .support-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .chat-list-panel {
                max-height: 400px;
            }

            .chat-conversation-panel {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-palette"></i>
                    </div>
                    <span>JB Creations</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-title">Main</div>
                    <ul class="nav-items">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-view="dashboard">
                                <i class="nav-icon fas fa-chart-line"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-view="orders">
                                <i class="nav-icon fas fa-shopping-bag"></i>
                                Orders
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-view="customers">
                                <i class="nav-icon fas fa-users"></i>
                                Customers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-view="support">
                                <i class="nav-icon fas fa-comments"></i>
                                Support Chats
                                <span class="nav-badge" id="supportChatBadge" style="display: none;">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-view="analytics">
                                <i class="nav-icon fas fa-chart-bar"></i>
                                Analytics
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Management</div>
                    <ul class="nav-items">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-view="products">
                                <i class="nav-icon fas fa-box"></i>
                                Products
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-view="inventory">
                                <i class="nav-icon fas fa-warehouse"></i>
                                Inventory
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-view="reports">
                                <i class="nav-icon fas fa-file-chart"></i>
                                Reports
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Settings</div>
                    <ul class="nav-items">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-view="settings">
                                <i class="nav-icon fas fa-cog"></i>
                                Settings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-view="profile">
                                <i class="nav-icon fas fa-user"></i>
                                Profile
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-bottom-nav" id="mobileBottomNav">
            <div class="mobile-nav-scroll">
                <a href="#" class="mobile-nav-item active" data-view="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="mobile-nav-item" data-view="orders">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Orders</span>
                </a>
                <a href="#" class="mobile-nav-item" data-view="customers">
                    <i class="fas fa-users"></i>
                    <span>Customers</span>
                </a>
                <a href="#" class="mobile-nav-item" data-view="support">
                    <i class="fas fa-comments"></i>
                    <span>Support</span>
                    <span class="mobile-nav-badge" id="mobileNavSupportBadge" style="display: none;">0</span>
                </a>
                <a href="#" class="mobile-nav-item" data-view="analytics">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
                <a href="#" class="mobile-nav-item" data-view="products">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="#" class="mobile-nav-item" data-view="inventory">
                    <i class="fas fa-warehouse"></i>
                    <span>Inventory</span>
                </a>
                <a href="#" class="mobile-nav-item" data-view="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1 class="page-title" id="page-title">Dashboard</h1>
                    <p class="page-subtitle" id="page-subtitle">Welcome to your admin dashboard</p>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        Export Data
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="content" id="main-content">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view">
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Total Orders</div>
                                    <div class="stat-value" id="total-orders">-</div>
                                </div>
                                <div class="stat-icon primary">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>12% vs last month</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Total Revenue</div>
                                    <div class="stat-value" id="total-revenue">-</div>
                                </div>
                                <div class="stat-icon success">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>8% vs last month</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Pending Orders</div>
                                    <div class="stat-value" id="pending-orders">-</div>
                                </div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="stat-change negative">
                                <i class="fas fa-arrow-down"></i>
                                <span>3% vs last month</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">New Customers</div>
                                    <div class="stat-value" id="new-customers">-</div>
                                </div>
                                <div class="stat-icon info">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>15% vs last month</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="showView('orders')">
                                    <i class="fas fa-shopping-bag"></i> View All Orders
                                </button>
                                <button class="btn btn-secondary" onclick="showView('customers')">
                                    <i class="fas fa-users"></i> View Customers
                                </button>
                                <button class="btn btn-secondary" onclick="exportOrdersCSV()">
                                    <i class="fas fa-download"></i> Export Orders
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders View -->
                <div id="orders-view" class="view" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <!-- Order Status Tabs -->
                            <div class="order-tabs">
                                <button class="order-tab" data-tab="all" onclick="switchOrderTab('all')">
                                    All Orders <span class="tab-count" id="tab-count-all">0</span>
                                </button>
                                <button class="order-tab active" data-tab="pending-labels" onclick="switchOrderTab('pending-labels')">
                                    Pending Labels <span class="tab-count" id="tab-count-pending-labels">0</span>
                                </button>
                                <button class="order-tab" data-tab="pending-rtd" onclick="switchOrderTab('pending-rtd')">
                                    Pending RTD <span class="tab-count" id="tab-count-pending-rtd">0</span>
                                </button>
                                <button class="order-tab" data-tab="pending-handover" onclick="switchOrderTab('pending-handover')">
                                    Pending Handover <span class="tab-count" id="tab-count-pending-handover">0</span>
                                </button>
                                <button class="order-tab" data-tab="completed" onclick="switchOrderTab('completed')">
                                    Completed <span class="tab-count" id="tab-count-completed">0</span>
                                </button>
                            </div>
                            
                            <!-- Search and Filter -->
                            <div class="search-filter-bar">
                                <input type="text" class="search-input" placeholder="Search orders..." id="order-search">
                                <select class="filter-select" id="date-sort-filter">
                                    <option value="latest">Latest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="email-asc">Sort by Email (A-Z)</option>
                                    <option value="email-desc">Sort by Email (Z-A)</option>
                                    <option value="name-asc">Sort by Name (A-Z)</option>
                                    <option value="name-desc">Sort by Name (Z-A)</option>
                                    <option value="phone-asc">Sort by Mobile (Asc)</option>
                                    <option value="phone-desc">Sort by Mobile (Desc)</option>
                                </select>
                            </div>
                            
                            <!-- Bulk Actions Bar for All Orders -->
                            <div class="bulk-actions-bar compact" id="all-orders-bulk-actions">
                                <span class="selected-count"><span id="all-selected-count">0</span> selected</span>
                                <button class="btn-delete-selected" onclick="deleteSelectedAllOrders()">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn-clear-selection" onclick="clearAllOrdersSelection()"></button>
                            </div>
                            
                            <!-- Mobile Select All Bar -->
                            <div class="mobile-select-all-bar" id="mobile-select-all-bar">
                                <label class="mobile-select-all-label">
                                    <input type="checkbox" id="mobile-select-all" onchange="toggleSelectAllOrders(this)">
                                    <span>Select All Orders</span>
                                </label>
                            </div>
                            
                            <div class="loading" id="all-orders-loading">
                                <div class="spinner"></div>
                            </div>
                            <div class="table-container" id="all-orders-table-container" style="display: none;">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" class="select-all-checkbox" id="all-select-all" onchange="toggleSelectAllOrders(this)"></th>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Email</th>
                                            <th>Qty</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="all-orders-table-body">
                                        <!-- All orders will be populated here -->
                                    </tbody>
                                </table>
                                
                                <!-- Pagination Controls -->
                                <div class="pagination-container">
                                    <div class="pagination-info">
                                        Showing <span id="showing-start">1</span> - <span id="showing-end">10</span> of <span id="total-orders-count">0</span> orders
                                    </div>
                                    <div class="pagination-controls">
                                        <div class="items-per-page">
                                            <label>Show:</label>
                                            <select id="items-per-page" onchange="changeItemsPerPage(this.value)">
                                                <option value="10">10</option>
                                                <option value="50">50</option>
                                                <option value="100">100</option>
                                            </select>
                                        </div>
                                        <button class="pagination-btn" id="prev-page-btn" onclick="goToPage(currentPage - 1)" disabled>
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <div class="pagination-pages" id="pagination-pages">
                                            <!-- Page buttons will be generated here -->
                                        </div>
                                        <button class="pagination-btn" id="next-page-btn" onclick="goToPage(currentPage + 1)">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other views placeholder -->
                <div id="customers-view" class="view" style="display: none;">
                    <!-- Customer Stats Grid -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Total Customers</div>
                                    <div class="stat-value" id="total-customers-stat">-</div>
                                </div>
                                <div class="stat-icon primary">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-info-circle"></i>
                                <span>Unique email addresses</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Repeat Customers</div>
                                    <div class="stat-value" id="repeat-customers-stat">-</div>
                                </div>
                                <div class="stat-icon success">
                                    <i class="fas fa-redo"></i>
                                </div>
                            </div>
                            <div class="stat-change positive" style="flex-direction: column; align-items: flex-start; gap: 0.25rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-users"></i>
                                    <span id="repeat-percentage-stat">0% of customers</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-shopping-bag"></i>
                                    <span id="repeat-orders-percentage-stat">0% of orders</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Total Orders</div>
                                    <div class="stat-value" id="customer-total-orders-stat">-</div>
                                </div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-chart-line"></i>
                                <span id="orders-from-repeat-stat">0 from repeat customers</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Avg Orders/Customer</div>
                                    <div class="stat-value" id="avg-orders-stat">-</div>
                                </div>
                                <div class="stat-icon info">
                                    <i class="fas fa-calculator"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-chart-bar"></i>
                                <span>Order frequency</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Avg Order Value</div>
                                    <div class="stat-value" id="avg-order-value-stat">0</div>
                                </div>
                                <div class="stat-icon secondary" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                                    <i class="fas fa-rupee-sign"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-receipt"></i>
                                <span>Per order average</span>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <!-- Top Frame Types Chart -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-pie" style="margin-right: 0.5rem; color: var(--primary);"></i>Popular Frame Types</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="frame-types-chart" height="250"></canvas>
                            </div>
                        </div>

                        <!-- Customer Distribution Chart -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-bar" style="margin-right: 0.5rem; color: var(--success);"></i>Customer Order Distribution</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="customer-distribution-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Customers Card -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-trophy" style="margin-right: 0.5rem; color: gold;"></i>Top 5 Customers (Most Orders)</h3>
                            <button class="btn btn-secondary btn-sm" onclick="toggleAllCustomers()">
                                <i class="fas fa-list"></i> <span id="view-all-btn-text">View All</span>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Email</th>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Total Orders</th>
                                            <th>Total Spent</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="top-customers-table-body">
                                        <!-- Top customers will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- All Customers Card (Initially Hidden) -->
                    <div class="card" id="all-customers-card" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-users" style="margin-right: 0.5rem; color: var(--info);"></i>All Customers</h3>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <input type="text" class="search-input" placeholder="Search by email..." id="customer-search" style="min-width: 250px;">
                                <select class="filter-select" id="customer-sort">
                                    <option value="orders-desc">Most Orders First</option>
                                    <option value="orders-asc">Least Orders First</option>
                                    <option value="email-asc">Email (A-Z)</option>
                                    <option value="email-desc">Email (Z-A)</option>
                                    <option value="spent-desc">Highest Spent First</option>
                                    <option value="spent-asc">Lowest Spent First</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Email</th>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Total Orders</th>
                                            <th>Total Spent</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="all-customers-table-body">
                                        <!-- All customers will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Support Chats View - WhatsApp-like Interface -->
                <div id="support-view" class="view" style="display: none;">
                    <!-- Chat Container - WhatsApp Style -->
                    <div class="whatsapp-chat-container">
                        <!-- Chat List Panel (Left Side) -->
                        <div class="chat-list-panel" id="chatListPanel">
                            <div class="chat-list-header">
                                <h3><i class="fas fa-comments"></i> Support Chats</h3>
                                <div class="chat-header-actions">
                                    <button class="btn btn-sm btn-secondary" onclick="cleanupOldChatsManual()" title="Delete old chats">
                                        <i class="fas fa-broom"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Chat Category Tabs -->
                            <div class="chat-category-tabs">
                                <button class="chat-tab active" id="unreadTab" onclick="filterChatsByCategory('unread')">
                                    <i class="fas fa-envelope"></i> Unread
                                    <span class="tab-badge" id="unreadTabBadge" style="display: none;">0</span>
                                </button>
                                <button class="chat-tab" id="allTab" onclick="filterChatsByCategory('all')">
                                    <i class="fas fa-inbox"></i> All Chats
                                </button>
                            </div>
                            <div class="chat-list" id="supportChatList">
                                <div class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading chats...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Conversation Panel (Right Side) -->
                        <div class="chat-conversation-panel" id="chatConversationPanel">
                            <!-- Mobile Back Button (hidden on desktop) -->
                            <div class="mobile-chat-header" id="mobileChatHeader" style="display: none;">
                                <button class="back-btn" onclick="goBackToList()">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <div class="mobile-user-info">
                                    <span class="mobile-user-name" id="mobileUserName">Customer</span>
                                    <span class="mobile-user-phone" id="mobileUserPhone"></span>
                                </div>
                                <div class="mobile-chat-actions" id="mobileChatActions"></div>
                            </div>
                            
                            <div class="no-chat-selected" id="noChatSelected">
                                <i class="fas fa-comments"></i>
                                <h3>Select a conversation</h3>
                                <p>Choose a chat from the list to start messaging</p>
                            </div>
                            
                            <!-- Conversation Content (hidden until chat selected) -->
                            <div class="conversation-content" id="conversationContent" style="display: none;">
                                <div class="conversation-header" id="desktopChatHeader">
                                    <div class="conversation-user-info">
                                        <h4 id="chatUserName">Customer</h4>
                                        <p id="chatUserDetails"></p>
                                    </div>
                                    <div class="conversation-actions" id="conversationActions">
                                    </div>
                                </div>
                                <div class="conversation-messages" id="conversationMessages">
                                </div>
                                <div class="conversation-input" id="conversationInput">
                                    <input type="text" id="adminMessageInput" placeholder="Type your reply..." 
                                           onkeypress="if(event.key==='Enter') sendAdminMessage()">
                                    <button onclick="sendAdminMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="analytics-view" class="view" style="display: none;">
                    <!-- Analytics Stats Grid -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Total Revenue</div>
                                    <div class="stat-value" id="analytics-total-revenue">0</div>
                                </div>
                                <div class="stat-icon success">
                                    <i class="fas fa-rupee-sign"></i>
                                </div>
                            </div>
                            <div class="stat-change positive" id="analytics-revenue-change">
                                <i class="fas fa-chart-line"></i>
                                <span>All time earnings</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Total Items Sold</div>
                                    <div class="stat-value" id="analytics-total-items">0</div>
                                </div>
                                <div class="stat-icon primary">
                                    <i class="fas fa-shopping-bag"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-box"></i>
                                <span>Individual frames</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Avg Order Value</div>
                                    <div class="stat-value" id="analytics-avg-order">0</div>
                                </div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-receipt"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-calculator"></i>
                                <span>Per transaction</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Conversion Rate</div>
                                    <div class="stat-value" id="analytics-conversion-rate">0%</div>
                                </div>
                                <div class="stat-icon info">
                                    <i class="fas fa-percentage"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-check-circle"></i>
                                <span>Completed orders</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">This Month Revenue</div>
                                    <div class="stat-value" id="analytics-month-revenue">0</div>
                                </div>
                                <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                            </div>
                            <div class="stat-change positive" id="analytics-month-orders">
                                <i class="fas fa-shopping-cart"></i>
                                <span>0 orders this month</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Today's Orders</div>
                                    <div class="stat-value" id="analytics-today-orders">0</div>
                                </div>
                                <div class="stat-icon" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="stat-change positive" id="analytics-today-revenue">
                                <i class="fas fa-rupee-sign"></i>
                                <span>0 revenue today</span>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 1 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-line" style="margin-right: 0.5rem; color: var(--primary);"></i>Revenue Over Time</h3>
                                <select class="filter-select" id="revenue-chart-period" onchange="updateRevenueChart()">
                                    <option value="7">Last 7 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <canvas id="revenue-over-time-chart" height="280"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-bar" style="margin-right: 0.5rem; color: var(--success);"></i>Orders by Status</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="orders-by-status-chart" height="280"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 2 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-pie" style="margin-right: 0.5rem; color: var(--warning);"></i>Popular Frame Sizes</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="analytics-frame-sizes-chart" height="280"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-palette" style="margin-right: 0.5rem; color: var(--info);"></i>Popular Frame Colors</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="analytics-frame-colors-chart" height="280"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Products & Best Selling Times -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-trophy" style="margin-right: 0.5rem; color: gold;"></i>Top 5 Best Sellers</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="table" id="top-products-table">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Frame Configuration</th>
                                                <th>Units Sold</th>
                                                <th>Revenue</th>
                                            </tr>
                                        </thead>
                                        <tbody id="top-products-table-body">
                                            <tr><td colspan="4" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-clock" style="margin-right: 0.5rem; color: var(--secondary);"></i>Orders by Day of Week</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="orders-by-day-chart" height="280"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Location Analytics -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem; color: var(--danger);"></i>Orders by Location (Top States)</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table" id="location-analytics-table">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>State</th>
                                            <th>Orders</th>
                                            <th>Revenue</th>
                                            <th>Avg Order Value</th>
                                        </tr>
                                    </thead>
                                    <tbody id="location-analytics-table-body">
                                        <tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="products-view" class="view" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Products</h3>
                        </div>
                        <div class="card-body">
                            <p style="text-align: center; color: var(--text-muted); padding: 3rem;">Product management coming soon...</p>
                        </div>
                    </div>
                </div>

                <div id="inventory-view" class="view" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Inventory</h3>
                        </div>
                        <div class="card-body">
                            <p style="text-align: center; color: var(--text-muted); padding: 3rem;">Inventory management coming soon...</p>
                        </div>
                    </div>
                </div>

                <div id="reports-view" class="view" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Reports</h3>
                        </div>
                        <div class="card-body">
                            <p style="text-align: center; color: var(--text-muted); padding: 3rem;">Reports coming soon...</p>
                        </div>
                    </div>
                </div>

                <div id="settings-view" class="view" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Settings</h3>
                        </div>
                        <div class="card-body">
                            <p style="text-align: center; color: var(--text-muted); padding: 3rem;">Settings panel coming soon...</p>
                        </div>
                    </div>
                </div>

                <div id="profile-view" class="view" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Profile</h3>
                        </div>
                        <div class="card-body">
                            <p style="text-align: center; color: var(--text-muted); padding: 3rem;">Profile settings coming soon...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Order Details</h3>
                <button class="modal-close" onclick="closeOrderModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="order-details" id="order-details-content">
                    <!-- Order details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let orders = [];
        let filteredOrders = [];
        let customers = [];
        let stats = {};
        
        // Pagination variables
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentTab = 'pending-labels';
        let tabFilteredOrders = [];

        // Navigation handling
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize navigation
            initNavigation();
            
            // Load initial data
            loadDashboardData();
            
            // Set up search and filter
            setupSearchAndFilter();
            
            // Set up periodic refresh
            setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
        });

        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Get view name
                    const viewName = this.getAttribute('data-view');
                    
                    // Sync mobile nav active state
                    syncMobileNavActive(viewName);
                    
                    // Show corresponding view
                    showView(viewName);
                });
            });
            
            // Mobile bottom navigation handling
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            mobileNavItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all mobile nav items
                    mobileNavItems.forEach(i => i.classList.remove('active'));
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Get view name
                    const viewName = this.getAttribute('data-view');
                    
                    // Sync sidebar nav active state
                    syncSidebarNavActive(viewName);
                    
                    // Show corresponding view
                    showView(viewName);
                });
            });
        }
        
        function syncMobileNavActive(viewName) {
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            mobileNavItems.forEach(item => {
                if (item.getAttribute('data-view') === viewName) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        function syncSidebarNavActive(viewName) {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                if (link.getAttribute('data-view') === viewName) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        function showView(viewName) {
            // Hide all views
            const views = document.querySelectorAll('.view');
            views.forEach(view => view.style.display = 'none');
            
            // Show selected view
            const targetView = document.getElementById(viewName + '-view');
            if (targetView) {
                targetView.style.display = 'block';
            }
            
            // Update page title
            updatePageTitle(viewName);
            
            // Load view-specific data
            loadViewData(viewName);
        }

        function updatePageTitle(viewName) {
            const titles = {
                'dashboard': 'Dashboard',
                'orders': 'Orders',
                'customers': 'Customers',
                'support': 'Support Chats',
                'analytics': 'Analytics',
                'products': 'Products',
                'inventory': 'Inventory',
                'reports': 'Reports',
                'settings': 'Settings',
                'profile': 'Profile'
            };
            
            const subtitles = {
                'dashboard': 'Welcome to your admin dashboard',
                'orders': 'Manage all customer orders',
                'customers': 'View and manage customers',
                'support': 'Chat with customers and provide support',
                'analytics': 'Business insights and analytics',
                'products': 'Manage your product catalog',
                'inventory': 'Track stock and inventory',
                'reports': 'Generate and view reports',
                'settings': 'Configure system settings',
                'profile': 'Manage your profile'
            };
            
            document.getElementById('page-title').textContent = titles[viewName] || 'Dashboard';
            document.getElementById('page-subtitle').textContent = subtitles[viewName] || 'Welcome to your admin dashboard';
        }

        function loadViewData(viewName) {
            switch(viewName) {
                case 'orders':
                    loadAllOrders();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'support':
                    loadSupportChats();
                    break;
                // Add more cases as needed
            }
        }

        function setupSearchAndFilter() {
            const searchInput = document.getElementById('order-search');
            const dateSortFilter = document.getElementById('date-sort-filter');
            
            if (searchInput) {
                searchInput.addEventListener('input', filterOrders);
            }
            
            if (dateSortFilter) {
                dateSortFilter.addEventListener('change', filterOrders);
            }
        }

        function filterOrders() {
            const searchTerm = document.getElementById('order-search')?.value.toLowerCase() || '';
            const dateSortFilter = document.getElementById('date-sort-filter')?.value || 'latest';
            
            filteredOrders = orders.filter(order => {
                const matchesSearch = !searchTerm || 
                    order.orderNumber.toLowerCase().includes(searchTerm) ||
                    order.customer?.name?.toLowerCase().includes(searchTerm) ||
                    order.customer?.email?.toLowerCase().includes(searchTerm) ||
                    order.customer?.phone?.toLowerCase().includes(searchTerm);
                
                return matchesSearch;
            });
            
            // Sort orders based on selected option
            filteredOrders.sort((a, b) => {
                switch(dateSortFilter) {
                    case 'oldest':
                        return getOrderDate(a.orderDate) - getOrderDate(b.orderDate);
                    case 'email-asc':
                        return (a.customer?.email || '').localeCompare(b.customer?.email || '');
                    case 'email-desc':
                        return (b.customer?.email || '').localeCompare(a.customer?.email || '');
                    case 'name-asc':
                        return (a.customer?.name || '').localeCompare(b.customer?.name || '');
                    case 'name-desc':
                        return (b.customer?.name || '').localeCompare(a.customer?.name || '');
                    case 'phone-asc':
                        return (a.customer?.phone || '').localeCompare(b.customer?.phone || '');
                    case 'phone-desc':
                        return (b.customer?.phone || '').localeCompare(a.customer?.phone || '');
                    default: // 'latest'
                        return getOrderDate(b.orderDate) - getOrderDate(a.orderDate);
                }
            });
            
            // Reset to first page when filtering
            currentPage = 1;
            
            // Apply tab filter and update table
            applyTabFilter();
        }
        
        // Helper function to get comparable date from various date formats
        function getOrderDate(dateInput) {
            if (!dateInput) return new Date(0); // Very old date for invalid dates
            
            // Handle Firebase Timestamp objects (with seconds and nanoseconds)
            if (dateInput && typeof dateInput === 'object' && dateInput.seconds) {
                return new Date(dateInput.seconds * 1000);
            } 
            // Handle regular date strings or Date objects
            else {
                const date = new Date(dateInput);
                return isNaN(date.getTime()) ? new Date(0) : date;
            }
        }

        // Data loading functions - Firebase version
        async function loadDashboardData() {
            console.log(' Loading dashboard data from Firebase...');
            
            // Check if Firebase API is available
            if (window.jbAPI && typeof window.jbAPI.getAllOrders === 'function') {
                try {
                    console.log(' Firebase API found, calling getAllOrders...');
                    console.log(' Type of getAllOrders:', typeof window.jbAPI.getAllOrders);
                    const result = await window.jbAPI.getAllOrders();
                    console.log(' getAllOrders result:', result);
                    
                    if (result.success && result.orders) {
                        // Transform Firebase data to match expected format
                        orders = result.orders.map(order => ({
                            orderNumber: order.orderNumber || order.orderId, // Use actual orderNumber, fallback to document ID
                            id: order.orderId, // Use orderId (the Firebase document ID) as the id for deletion
                            orderId: order.orderId, // Also keep orderId explicitly
                            customer: {
                                name: order.customerName || order.customer?.name || 'Guest',
                                email: order.customerEmail || order.customer?.email || '',
                                phone: order.customerPhone || order.customer?.phone || '',
                                address: order.customerAddress || order.customer?.address || '',
                                specialInstructions: order.specialInstructions || order.customer?.specialInstructions || ''
                            },
                            status: order.status || 'pending',
                            orderDate: order.orderDate || order.createdAt,
                            totals: order.totals || {
                                total: order.totalAmount || 299
                            },
                            items: order.items || [], // Use the actual items array from new structure
                            images: order.images || [], // Use the actual images array
                            deliveryMethod: order.deliveryMethod || 'standard',
                            usingCloudinary: order.usingCloudinary || false,
                            paymentId: order.paymentId || null
                        }));
                        
                        filteredOrders = [...orders];
                        
                        // Apply default sorting (latest first)
                        filteredOrders.sort((a, b) => {
                            const dateA = getOrderDate(a.orderDate);
                            const dateB = getOrderDate(b.orderDate);
                            return dateB - dateA; // Latest first by default
                        });
                        
                        console.log(` Loaded ${orders.length} orders from Firebase`);
                        
                        updateDashboardStats();
                        updateRecentOrdersTable();
                        updateTabCounts(); // Update tab counts
                        applyTabFilter(); // Apply current tab filter
                        debugAfterLoad(); // Debug the loaded data
                        return;
                    } else {
                        console.error(' Failed to load orders from Firebase:', result?.error || 'Unknown error');
                        console.log(' Full result object:', JSON.stringify(result, null, 2));
                    }
                } catch (error) {
                    console.error(' Error loading Firebase data:', error);
                    console.error(' Error details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                }
            }
            
            // Fallback - set empty data if Firebase not available
            console.warn(' Firebase API not available, using empty data');
            console.log(' Available window properties:', Object.keys(window).filter(k => k.includes('firebase') || k.includes('jb')));
            console.log(' window.jbAPI exists:', !!window.jbAPI);
            if (window.jbAPI) {
                console.log(' jbAPI type:', typeof window.jbAPI);
                console.log(' jbAPI constructor:', window.jbAPI.constructor.name);
                console.log(' jbAPI methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.jbAPI)));
                console.log(' jbAPI direct properties:', Object.keys(window.jbAPI));
                console.log(' getAllOrders method exists:', typeof window.jbAPI.getAllOrders);
            }
            orders = [];
            filteredOrders = [];
            updateDashboardStats();
            updateRecentOrdersTable();
        }

        function updateDashboardStats() {
            const totalOrders = orders.length;
            const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.totals.total || 0), 0);
            const pendingOrders = orders.filter(order => order.status === 'pending').length;
            const today = new Date().toDateString();
            const newCustomers = orders.filter(order => new Date(order.orderDate).toDateString() === today).length;

            document.getElementById('total-orders').textContent = totalOrders.toLocaleString();
            document.getElementById('total-revenue').textContent = '' + totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 });
            document.getElementById('pending-orders').textContent = pendingOrders.toLocaleString();
            document.getElementById('new-customers').textContent = newCustomers.toLocaleString();
        }

        // No longer needed - dashboard doesn't show recent orders table
        function updateRecentOrdersTable() {
            // Empty function - recent orders table removed from dashboard
        }

        async function loadAllOrders() {
            const tableBody = document.getElementById('all-orders-table-body');
            const loading = document.getElementById('all-orders-loading');
            const tableContainer = document.getElementById('all-orders-table-container');
            
            if (!tableBody || !loading || !tableContainer) return;
            
            // Show loading
            loading.style.display = 'flex';
            tableContainer.style.display = 'none';
            
            // Update tab counts and apply filter
            updateTabCounts();
            applyTabFilter();
            
            // Hide loading, show table
            loading.style.display = 'none';
            tableContainer.style.display = 'block';
        }

        // Track selected orders for All Orders table
        let selectedAllOrders = new Set();
        
        // ============ TAB AND PAGINATION FUNCTIONS ============
        
        function switchOrderTab(tab) {
            currentTab = tab;
            currentPage = 1; // Reset to first page when switching tabs
            
            // Update tab active state
            document.querySelectorAll('.order-tab').forEach(t => {
                t.classList.remove('active');
                if (t.dataset.tab === tab) {
                    t.classList.add('active');
                }
            });
            
            // Apply filter and update table
            applyTabFilter();
        }
        
        function applyTabFilter() {
            // First apply search filters
            const searchTerm = document.getElementById('order-search')?.value.toLowerCase() || '';
            const dateSortFilter = document.getElementById('date-sort-filter')?.value || 'latest';
            
            let baseOrders = orders.filter(order => {
                const matchesSearch = !searchTerm || 
                    order.orderNumber.toLowerCase().includes(searchTerm) ||
                    order.customer?.name?.toLowerCase().includes(searchTerm) ||
                    order.customer?.email?.toLowerCase().includes(searchTerm) ||
                    order.customer?.phone?.toLowerCase().includes(searchTerm);
                
                return matchesSearch;
            });
            
            // Then apply tab filter
            switch(currentTab) {
                case 'pending-labels':
                    tabFilteredOrders = baseOrders.filter(o => o.status === 'pending');
                    break;
                case 'pending-rtd':
                    tabFilteredOrders = baseOrders.filter(o => o.status === 'processing');
                    break;
                case 'pending-handover':
                    tabFilteredOrders = baseOrders.filter(o => o.status === 'shipped');
                    break;
                case 'completed':
                    tabFilteredOrders = baseOrders.filter(o => o.status === 'completed' || o.status === 'delivered');
                    break;
                default:
                    tabFilteredOrders = baseOrders;
            }
            
            // Sort orders based on selected option
            tabFilteredOrders.sort((a, b) => {
                switch(dateSortFilter) {
                    case 'oldest':
                        return getOrderDate(a.orderDate) - getOrderDate(b.orderDate);
                    case 'email-asc':
                        return (a.customer?.email || '').localeCompare(b.customer?.email || '');
                    case 'email-desc':
                        return (b.customer?.email || '').localeCompare(a.customer?.email || '');
                    case 'name-asc':
                        return (a.customer?.name || '').localeCompare(b.customer?.name || '');
                    case 'name-desc':
                        return (b.customer?.name || '').localeCompare(a.customer?.name || '');
                    case 'phone-asc':
                        return (a.customer?.phone || '').localeCompare(b.customer?.phone || '');
                    case 'phone-desc':
                        return (b.customer?.phone || '').localeCompare(a.customer?.phone || '');
                    default: // 'latest'
                        return getOrderDate(b.orderDate) - getOrderDate(a.orderDate);
                }
            });
            
            // Update table with pagination
            updateAllOrdersTable(tabFilteredOrders);
            
            // Ensure loading is hidden and table is shown
            const loading = document.getElementById('all-orders-loading');
            const tableContainer = document.getElementById('all-orders-table-container');
            if (loading) loading.style.display = 'none';
            if (tableContainer) tableContainer.style.display = 'block';
        }
        
        function updateTabCounts() {
            // All orders
            document.getElementById('tab-count-all').textContent = orders.length;
            
            // Pending Labels (pending status)
            const pendingLabelsCount = orders.filter(o => o.status === 'pending').length;
            document.getElementById('tab-count-pending-labels').textContent = pendingLabelsCount;
            
            // Pending RTD (processing status)
            const pendingRTDCount = orders.filter(o => o.status === 'processing').length;
            document.getElementById('tab-count-pending-rtd').textContent = pendingRTDCount;
            
            // Pending Handover (shipped status)
            const pendingHandoverCount = orders.filter(o => o.status === 'shipped').length;
            document.getElementById('tab-count-pending-handover').textContent = pendingHandoverCount;
            
            // Completed (completed or delivered status)
            const completedCount = orders.filter(o => o.status === 'completed' || o.status === 'delivered').length;
            document.getElementById('tab-count-completed').textContent = completedCount;
        }
        
        function updateAllOrdersTable(ordersToShow) {
            const tableBody = document.getElementById('all-orders-table-body');
            if (!tableBody) return;
            
            // Clear selection when table updates
            selectedAllOrders.clear();
            updateAllBulkActionsBar();
            
            // Calculate pagination
            const totalOrders = ordersToShow.length;
            const totalPages = Math.ceil(totalOrders / itemsPerPage);
            
            // Make sure current page is valid
            if (currentPage > totalPages) currentPage = totalPages || 1;
            if (currentPage < 1) currentPage = 1;
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalOrders);
            const paginatedOrders = ordersToShow.slice(startIndex, endIndex);
            
            // Update pagination info
            document.getElementById('showing-start').textContent = totalOrders > 0 ? startIndex + 1 : 0;
            document.getElementById('showing-end').textContent = endIndex;
            document.getElementById('total-orders-count').textContent = totalOrders;
            
            // Update pagination buttons
            updatePaginationButtons(totalPages);
            
            if (paginatedOrders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-muted); padding: 2rem;">No orders found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = paginatedOrders.map(order => {
                const orderId = order.id || order.orderId || order.orderNumber;
                const quantity = order.items ? order.items.length : (order.quantity || 1);
                const customerName = order.customer.name || 'N/A';
                const customerEmail = order.customer.email || 'N/A';
                const customerPhone = order.customer.phone || 'N/A';
                const amount = parseFloat(order.totals.total || 0).toFixed(2);
                const date = formatDate(order.orderDate);
                const statusBadge = getStatusBadge(order.status);
                
                return `
                <tr class="order-row clickable-row" data-order-id="${orderId}" data-order-number="${order.orderNumber}" onclick="handleOrderRowClick(event, '${order.orderNumber}')">
                    <td class="col-checkbox" onclick="event.stopPropagation()"><input type="checkbox" class="order-checkbox all-order-checkbox" data-order-id="${orderId}" data-order-number="${order.orderNumber}" onchange="toggleAllOrderSelection(this)"></td>
                    <td class="col-order-id"><strong>#${order.orderNumber}</strong></td>
                    <td class="col-customer">${customerName}</td>
                    <td class="col-email">${customerEmail}</td>
                    <td class="col-phone">${customerPhone}</td>
                    <td class="col-qty">${quantity}</td>
                    <td class="col-date">${date}</td>
                    <td class="col-amount"><strong style="color: var(--success);">${amount}</strong></td>
                    <td class="col-status">${statusBadge}</td>
                    <td class="col-actions" onclick="event.stopPropagation()">
                        <button class="action-btn delete" onclick="deleteOrder('${orderId}', '${order.orderNumber}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
            
            // Reset select all checkbox
            const selectAllCheckbox = document.getElementById('all-select-all');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
        }
        
        function updatePaginationButtons(totalPages) {
            const paginationPages = document.getElementById('pagination-pages');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            
            if (!paginationPages) return;
            
            // Update prev/next buttons
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
            
            // Generate page buttons - cleaner format: current, next, ..., last
            let pagesHTML = '';
            
            // Current page (always shown)
            pagesHTML += `<button class="page-btn active" onclick="goToPage(${currentPage})">${currentPage}</button>`;
            
            // Next page (if exists and not same as last)
            if (currentPage + 1 < totalPages) {
                pagesHTML += `<button class="page-btn" onclick="goToPage(${currentPage + 1})">${currentPage + 1}</button>`;
            }
            
            // Ellipsis and last page (if there are more pages)
            if (currentPage + 2 < totalPages) {
                pagesHTML += `<span style="padding: 0 0.5rem; color: var(--text-muted);">...</span>`;
            }
            
            // Last page (always shown if different from current)
            if (currentPage < totalPages) {
                pagesHTML += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            paginationPages.innerHTML = pagesHTML;
        }
        
        function goToPage(page) {
            currentPage = page;
            applyTabFilter();
            
            // Scroll to top of table
            const tableContainer = document.getElementById('all-orders-table-container');
            if (tableContainer) {
                tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function changeItemsPerPage(value) {
            itemsPerPage = parseInt(value);
            currentPage = 1; // Reset to first page
            applyTabFilter();
        }

        // Utility functions
        function formatDate(dateInput) {
            if (!dateInput) return 'N/A';
            
            let date;
            
            // Handle Firebase Timestamp objects (with seconds and nanoseconds)
            if (dateInput && typeof dateInput === 'object' && dateInput.seconds) {
                date = new Date(dateInput.seconds * 1000);
            } 
            // Handle regular date strings or Date objects
            else {
                date = new Date(dateInput);
            }
            
            // Check if date is valid
            if (isNaN(date.getTime())) {
                console.warn('Invalid date format:', dateInput);
                return 'Invalid Date';
            }
            
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusBadge(status) {
            const statusClasses = {
                'pending': 'badge-warning',
                'processing': 'badge-info',
                'shipped': 'badge-info',
                'delivered': 'badge-success',
                'completed': 'badge-success',
                'cancelled': 'badge-danger'
            };
            
            const className = statusClasses[status] || 'badge-info';
            const displayStatus = status || 'pending';
            return `<span class="badge ${className}">${displayStatus}</span>`;
        }

        // Handle order row click to view order
        function handleOrderRowClick(event, orderNumber) {
            // Don't open if clicking on checkbox or delete button
            if (event.target.closest('.col-checkbox') || event.target.closest('.col-actions')) {
                return;
            }
            viewOrder(orderNumber);
        }

        // Action functions - Firebase version
        async function viewOrder(orderNumber) {
            try {
                //  DEBUG: Log all orders that match this order number
                console.log(` Searching for orders with orderNumber: ${orderNumber}`);
                const matchingOrders = orders.filter(o => o.id === orderNumber || o.orderNumber === orderNumber);
                console.log(` Found ${matchingOrders.length} matching orders:`);
                matchingOrders.forEach((order, index) => {
                    console.log(`  Order ${index + 1}:`, {
                        id: order.id,
                        orderNumber: order.orderNumber,
                        customerName: order.customer?.name,
                        customerEmail: order.customer?.email,
                        hasImagePaths: order.items?.some(item => 
                            item.originalImagePath || item.displayImagePath || item.printImagePath
                        ),
                        usingCloudinary: order.usingCloudinary,
                        timestamp: order.orderDate
                    });
                });

                // Find order in our existing data instead of fetching from API
                const order = orders.find(o => o.id === orderNumber || o.orderNumber === orderNumber);
                
                if (order) {
                    // Add detailed debugging for each order
                    console.log('======= ORDER DEBUG INFO =======');
                    console.log('Order ID:', order.id);
                    console.log('Order full data:', JSON.stringify(order));
                    console.log('Order items:', order.items);
                    console.log('Direct images array:', order.images);
                    console.log('Using Cloudinary:', order.usingCloudinary ? 'Yes' : 'No');
                    
                    if (order.images && order.images.length > 0) {
                        console.log('First image data preview:', 
                            order.usingCloudinary ? 
                                `Cloudinary URL: ${order.images[0].originalImage}` : 
                                (order.images[0].data ? order.images[0].data.substring(0, 100) + '...' : 'No data')
                        );
                        
                        // Check for Cloudinary IDs
                        if (order.images[0].cloudinaryPublicId) {
                            console.log('Found Cloudinary Public ID:', order.images[0].cloudinaryPublicId);
                        }
                    }
                    
                    if (order.items && order.items.length > 0) {
                        console.log('First item image properties:',  {
                            hasOriginalImagePath: !!order.items[0].originalImagePath,
                            hasPrintImage: !!order.items[0].printImage,
                            hasPreviewImage: !!order.items[0].previewImage
                        });
                    }
                    console.log('======= END DEBUG INFO =======');
                    
                    showOrderModal(order);
                } else {
                    console.error('Order not found:', orderNumber);
                    alert('Order not found: ' + orderNumber);
                }
            } catch (error) {
                console.error('Error viewing order details:', error);
                alert('Error loading order details');
            }
        }

        function showOrderModal(order) {
            console.log(' Showing order modal for:', order);
            const modal = document.getElementById('order-modal');
            const content = document.getElementById('order-details-content');
            
            // Debug order structure
            console.log('Order items:', order.items);
            console.log('Order customer:', order.customer);
            console.log('Raw order images from Firebase:', order.images);
            console.log('Using Cloudinary:', order.usingCloudinary ? 'Yes' : 'No');
            
            // Generate items HTML with images - ENHANCED IMAGE DETECTION
            const itemsHTML = order.items.map((item, index) => {
                // Extended debug info to trace all possible image sources
                console.log(` Item ${index + 1} - ALL IMAGE PROPERTIES:`);
                console.log(`- originalImagePath:`, item.originalImagePath);
                console.log(`- printImage:`, item.printImage ? `Available (${item.printImage.substring(0, 30)}...)` : 'Not available');
                console.log(`- previewImage:`, item.previewImage ? `Available (${item.previewImage.substring(0, 30)}...)` : 'Not available');
                console.log(`- displayImage:`, item.displayImage ? `Available (${item.displayImage.substring(0, 30)}...)` : 'Not available');
                
                // Check if there are Cloudinary URLs available in the order images
                let cloudinaryUrl = null;
                let base64Image = null;
                
                if (order.images && order.images.length > index) {
                    const orderImage = order.images[index];
                    
                    // Check for Cloudinary URL in multiple possible locations (new structure uses 'original', 'print', 'display')
                    if (orderImage.original && orderImage.original.startsWith('https://res.cloudinary.com/')) {
                        cloudinaryUrl = orderImage.original;
                        console.log(`- Found Cloudinary URL in original:`, cloudinaryUrl);
                    } else if (orderImage.print && orderImage.print.startsWith('https://res.cloudinary.com/')) {
                        cloudinaryUrl = orderImage.print;
                        console.log(`- Found Cloudinary URL in print:`, cloudinaryUrl);
                    } else if (orderImage.display && orderImage.display.startsWith('https://res.cloudinary.com/')) {
                        cloudinaryUrl = orderImage.display;
                        console.log(`- Found Cloudinary URL in display:`, cloudinaryUrl);
                    }
                    // Also check old structure (originalImage, printImage, displayImage)
                    else if (orderImage.originalImage && orderImage.originalImage.startsWith('https://res.cloudinary.com/')) {
                        cloudinaryUrl = orderImage.originalImage;
                        console.log(`- Found Cloudinary URL in originalImage:`, cloudinaryUrl);
                    } else if (orderImage.printImage && orderImage.printImage.startsWith('https://res.cloudinary.com/')) {
                        cloudinaryUrl = orderImage.printImage;
                        console.log(`- Found Cloudinary URL in printImage:`, cloudinaryUrl);
                    } else if (orderImage.displayImage && orderImage.displayImage.startsWith('https://res.cloudinary.com/')) {
                        cloudinaryUrl = orderImage.displayImage;
                        console.log(`- Found Cloudinary URL in displayImage:`, cloudinaryUrl);
                    }
                    
                    // Check for base64 image data (both new and old structures)
                    if (!cloudinaryUrl) {
                        const base64Sources = [
                            orderImage.original, orderImage.print, orderImage.display,
                            orderImage.originalImage, orderImage.printImage, orderImage.displayImage,
                            orderImage.data
                        ];
                        for (const src of base64Sources) {
                            if (src && src.startsWith('data:')) {
                                base64Image = src;
                                console.log(`- Found base64 image:`, base64Image.substring(0, 50) + '...');
                                break;
                            }
                        }
                    }
                }
                
                // Also check item.cloudinaryUrl (direct cloudinary URL on item)
                if (!cloudinaryUrl && item.cloudinaryUrl && item.cloudinaryUrl.startsWith('https://res.cloudinary.com/')) {
                    cloudinaryUrl = item.cloudinaryUrl;
                    console.log(`- Found Cloudinary URL in item.cloudinaryUrl:`, cloudinaryUrl);
                }
                
                // Also check the item itself for image data
                if (!cloudinaryUrl && !base64Image) {
                    // Priority: printImage (processed image without frame) > previewImage (with frame borders)
                    if (item.printImage && item.printImage.startsWith('https://res.cloudinary.com/')) {
                        cloudinaryUrl = item.printImage;
                        console.log(`- Found Cloudinary URL in item.printImage:`, cloudinaryUrl);
                    } else if (item.previewImage && item.previewImage.startsWith('https://res.cloudinary.com/')) {
                        cloudinaryUrl = item.previewImage;
                        console.log(`- Found Cloudinary URL in item.previewImage:`, cloudinaryUrl);
                    } else if (item.printImage && item.printImage.startsWith('data:')) {
                        base64Image = item.printImage;
                        console.log(`- Found base64 in item.printImage (processed without frame):`, base64Image.substring(0, 50) + '...');
                    } else if (item.previewImage && item.previewImage.startsWith('data:')) {
                        base64Image = item.previewImage;
                        console.log(`- Found base64 in item.previewImage:`, base64Image.substring(0, 50) + '...');
                    } else if (item.displayImage && item.displayImage.startsWith('data:')) {
                        base64Image = item.displayImage;
                        console.log(`- Found base64 in item.displayImage:`, base64Image.substring(0, 50) + '...');
                    }
                }
                
                // Also check for fallback images in the images array (new Firebase structure)
                if (!cloudinaryUrl && !base64Image && order.images && order.images[index]) {
                    const imageEntry = order.images[index];
                    if (imageEntry.fallbackImage && imageEntry.fallbackImage.startsWith('data:')) {
                        base64Image = imageEntry.fallbackImage;
                        console.log(`- Found fallback image:`, base64Image.substring(0, 50) + '...');
                    }
                }
                
                // Choose the best available image with Cloudinary preferred
                const bestImage = cloudinaryUrl || base64Image || item.originalImagePath || null;
                
                console.log(`- BEST IMAGE SELECTED:`, bestImage ? (
                    bestImage.startsWith('https://') ? 
                        `Cloudinary URL: ${bestImage}` : 
                        `Base64: ${bestImage.substring(0, 30)}...`
                ) : 'No image found');
                
                return `
                <div class="order-item-card">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">Item ${index + 1}</h4>
                    
                    <div class="item-details">
                        <div class="detail-row">
                            <span class="detail-label">Frame Size:</span>
                            <span class="detail-value">${item.frameSize?.size || 'Standard'} ${item.frameSize?.orientation || ''}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Frame Color:</span>
                            <span class="detail-value">${item.frameColor || 'Standard'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Frame Texture:</span>
                            <span class="detail-value">${item.frameTexture || 'Standard'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">White Border:</span>
                            <span class="detail-value">${item.whiteBorder ? 'Yes' : 'No'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Price:</span>
                            <span class="detail-value">${item.price || '349'}</span>
                        </div>
                    </div>
                    
                    <div class="adjustments-section">
                        <h5 style="color: var(--text-secondary); margin-bottom: 10px;">Image Adjustments:</h5>
                        <div class="adjustment-grid">
                            <div class="adjustment-item">Brightness: ${item.adjustments?.brightness || '0'}%</div>
                            <div class="adjustment-item">Contrast: ${item.adjustments?.contrast || '0'}%</div>
                            <div class="adjustment-item">Highlights: ${item.adjustments?.highlights || '0'}%</div>
                            <div class="adjustment-item">Shadows: ${item.adjustments?.shadows || '0'}%</div>
                            <div class="adjustment-item">Vibrance: ${item.adjustments?.vibrance || '0'}%</div>
                            <div class="adjustment-item">Zoom: ${item.zoom || '1'}x</div>
                        </div>
                    </div>
                    
                    <div class="image-section">
                        <h5 style="color: var(--text-secondary); margin-bottom: 15px;">
                            <i class="fas fa-print" style="margin-right: 8px; color: var(--primary);"></i>
                            Print-Ready Image (High Quality):
                        </h5>
                        <div class="image-grid">
                            ${bestImage ? `
                                <div class="image-card" style="border: 2px solid ${cloudinaryUrl ? 'var(--success)' : 'var(--warning)'};">
                                    <div style="position: absolute; top: 10px; right: 10px; z-index: 10;">
                                        <span class="badge ${cloudinaryUrl ? 'badge-success' : 'badge-warning'}" style="font-size: 0.7em;">
                                            ${cloudinaryUrl ? ' HQ Cloud' : ' Local'}
                                        </span>
                                    </div>
                                    <img src="${bestImage}" 
                                         alt="Print Ready Image" 
                                         style="width: 100%; height: 250px; object-fit: contain; background: #f8f9fa; border-radius: 4px;"
                                         onerror="console.error('Failed to load image:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';"
                                         onload="console.log(' High-quality print image loaded for item ${index + 1}')">
                                    <div style="display: none; padding: 40px; color: var(--text-muted); font-style: italic; text-align: center; background: #f8f9fa; border-radius: 4px;">
                                        <i class="fas fa-exclamation-triangle" style="font-size: 2em; color: var(--warning); display: block; margin-bottom: 10px;"></i>
                                        Image failed to load<br>
                                        <small style="word-break: break-all;">URL: ${bestImage.substring(0, 80)}...</small>
                                    </div>
                                    <div style="margin-top: 12px; padding: 10px; background: var(--bg-tertiary); border-radius: 4px;">
                                        <p style="margin: 0 0 8px 0; font-size: 0.85em; color: var(--text-secondary);">
                                            <strong>${cloudinaryUrl ? ' Cloudinary (Full Resolution)' : ' Base64 Image'}</strong>
                                            ${cloudinaryUrl ? '<br><span style="color: var(--success);">Ready for professional printing</span>' : '<br><span style="color: var(--warning);">Backup image - check quality</span>'}
                                        </p>
                                        <button data-image-data="${encodeURIComponent(bestImage)}" 
                                                data-filename="${order.orderNumber}_item${index + 1}_PRINT.jpg"
                                                onclick="downloadImage(this.dataset.imageData, this.dataset.filename)"
                                                class="download-btn" style="width: 100%; justify-content: center;">
                                            <i class="fas fa-download"></i> Download for Print
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <div class="image-card empty" style="border: 2px dashed var(--danger);">
                                    <div style="padding: 40px; color: var(--text-muted); font-style: italic; text-align: center;">
                                        <i class="fas fa-image" style="font-size: 3em; color: var(--danger); display: block; margin-bottom: 15px;"></i>
                                        <strong style="color: var(--danger);">No image available</strong><br>
                                        <small>The print image could not be retrieved for this order.</small><br>
                                        <small>Please contact customer for the original image.</small>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `}).join('');
            
            const orderQuantity = order.items ? order.items.length : (order.quantity || 1);
            
            content.innerHTML = `
                <div class="order-header">
                    <div class="detail-grid">
                        <div class="detail-row">
                            <span class="detail-label">Order Number:</span>
                            <span class="detail-value" style="font-weight: 600; color: var(--primary);">#${order.orderNumber}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Customer Name:</span>
                            <span class="detail-value">${order.customer.name || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">${order.customer.email || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value">${order.customer.phone || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Quantity:</span>
                            <span class="detail-value"><span class="badge badge-info" style="font-size: 1em;">${orderQuantity} item${orderQuantity > 1 ? 's' : ''}</span></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Date:</span>
                            <span class="detail-value">${formatDate(order.orderDate)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value">${getStatusBadge(order.status)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Total Amount:</span>
                            <span class="detail-value" style="font-weight: 600; color: var(--success);">${order.totals.total}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Delivery Method:</span>
                            <span class="detail-value">${order.deliveryMethod === 'express' ? 'Express (2-3 days)' : 'Standard (5-7 days)'}</span>
                        </div>
                    </div>
                    
                    ${order.customer.address ? `
                        <div class="detail-row" style="margin-top: 15px;">
                            <span class="detail-label">Address:</span>
                            <span class="detail-value">${order.customer.address}</span>
                        </div>
                    ` : ''}
                    
                    ${order.customer.specialInstructions ? `
                        <div class="detail-row" style="margin-top: 15px;">
                            <span class="detail-label">Special Instructions:</span>
                            <span class="detail-value">${order.customer.specialInstructions}</span>
                        </div>
                    ` : ''}
                </div>
                
                <div class="items-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--text-primary); margin: 0;">
                            <i class="fas fa-box" style="margin-right: 8px; color: var(--primary);"></i>
                            Order Items (${order.items.length})
                        </h3>
                        ${order.items.length > 1 ? `
                            <button class="btn btn-primary btn-sm" onclick="downloadAllOrderImages('${order.orderNumber}')" style="padding: 8px 16px;">
                                <i class="fas fa-download"></i> Download All Images
                            </button>
                        ` : ''}
                    </div>
                    ${itemsHTML}
                </div>
            `;
            
            modal.classList.add('show');
        }

        function closeOrderModal() {
            const modal = document.getElementById('order-modal');
            modal.classList.remove('show');
        }

        // Debug function to check Firebase order data
        function debugOrderData() {
            console.log(' Current orders data:', orders);
            if (orders.length > 0) {
                console.log(' First order structure:', orders[0]);
                console.log(' First order items:', orders[0].items);
                console.log(' First order images array:', orders[0].images);
                if (orders[0].items && orders[0].items.length > 0) {
                    console.log(' First item image data:', orders[0].items[0]);
                    console.log(' First item properties:', Object.keys(orders[0].items[0]));
                }
            }
        }
        
        // Add a test function to manually check order structure
        function testOrderStructure() {
            console.log('=== TESTING ORDER STRUCTURE ===');
            
            // Check localStorage for any stored orders
            const localOrders = localStorage.getItem('jb_orders');
            if (localOrders) {
                try {
                    const parsedOrders = JSON.parse(localOrders);
                    console.log(' LocalStorage orders found:', parsedOrders);
                } catch (e) {
                    console.log(' Error parsing localStorage orders:', e);
                }
            } else {
                console.log(' No orders in localStorage');
            }
            
            // Check sessionStorage for any stored orders
            const sessionOrders = sessionStorage.getItem('jb_orders');
            if (sessionOrders) {
                try {
                    const parsedOrders = JSON.parse(sessionOrders);
                    console.log(' SessionStorage orders found:', parsedOrders);
                } catch (e) {
                    console.log(' Error parsing sessionStorage orders:', e);
                }
            } else {
                console.log(' No orders in sessionStorage');
            }
            
            // Check current orders variable
            console.log(' Current orders array:', orders);
            console.log(' Orders length:', orders.length);
            
            // Check Firebase API availability
            console.log(' Firebase API available:', !!window.jbAPI);
            if (window.jbAPI) {
                console.log(' Firebase API methods:', Object.keys(window.jbAPI));
            }
        }

        // Add this function to window for easy console access
        window.testOrderStructure = testOrderStructure;
        window.debugOrderData = debugOrderData;
        
        // Test function to create a sample order for debugging
        function createTestOrder() {
            const testOrder = {
                id: 'TEST' + Date.now(),
                orderNumber: 'TEST' + Date.now(),
                customer: {
                    name: 'Test Customer',
                    email: 'test@example.com',
                    phone: '+91 9999999999',
                    address: 'Test Address, Test City'
                },
                orderDate: new Date().toISOString(),
                status: 'pending',
                totals: { total: 349 },
                usingCloudinary: false,
                items: [{
                    frameSize: { size: '13x10', orientation: 'Portrait' },
                    frameColor: 'Black',
                    frameTexture: 'Matte',
                    price: 349,
                    adjustments: {
                        brightness: 0,
                        contrast: 0,
                        highlights: 0,
                        shadows: 0,
                        vibrance: 0
                    },
                    zoom: 1,
                    printImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=='
                }],
                images: [{
                    originalImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
                    printImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
                    displayImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=='
                }]
            };
            
            // Add test order to orders array
            orders.unshift(testOrder);
            filteredOrders.unshift(testOrder);
            
            // Update the display
            updateDashboardStats();
            updateRecentOrdersTable();
            updateAllOrdersTable(filteredOrders);
            
            console.log(' Test order created:', testOrder);
            alert('Test order created! Check the orders table.');
        }
        
        window.createTestOrder = createTestOrder;

        // Auto-run debug when orders are loaded
        function debugAfterLoad() {
            setTimeout(() => {
                debugOrderData();
            }, 2000);
        }

        // Download all images for an order
        async function downloadAllOrderImages(orderNumber) {
            console.log(' Downloading all images for order:', orderNumber);
            
            const order = orders.find(o => o.orderNumber === orderNumber);
            if (!order || !order.items || order.items.length === 0) {
                alert('No items found for this order');
                return;
            }
            
            // Show progress notification
            showNotification(`Downloading ${order.items.length} image(s)...`, 'info');
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < order.items.length; i++) {
                const item = order.items[i];
                
                // Find the best image for this item (same logic as showOrderModal)
                let bestImage = null;
                
                // Check Cloudinary URLs first
                if (order.images && order.images[i]) {
                    const orderImage = order.images[i];
                    bestImage = orderImage.print || orderImage.original || orderImage.display;
                    if (!bestImage && orderImage.originalImage) {
                        bestImage = orderImage.originalImage.startsWith('https://') ? orderImage.originalImage : null;
                    }
                    if (!bestImage && orderImage.printImage) {
                        bestImage = orderImage.printImage.startsWith('https://') ? orderImage.printImage : null;
                    }
                }
                
                // Fallback to item properties
                if (!bestImage) {
                    bestImage = item.cloudinaryUrl || item.printImage || item.originalImage || item.displayImage;
                }
                
                // Check for fallback base64 images
                if (!bestImage && order.images && order.images[i]) {
                    const orderImage = order.images[i];
                    bestImage = orderImage.fallbackImage || orderImage.originalImage || orderImage.printImage;
                }
                
                if (bestImage) {
                    const filename = `${orderNumber}_item${i + 1}_PRINT.jpg`;
                    try {
                        await downloadImageAsync(bestImage, filename);
                        successCount++;
                        // Small delay between downloads to prevent browser throttling
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } catch (error) {
                        console.error(`Failed to download image ${i + 1}:`, error);
                        failCount++;
                    }
                } else {
                    console.warn(`No image found for item ${i + 1}`);
                    failCount++;
                }
            }
            
            // Show completion notification
            if (failCount === 0) {
                showNotification(`Successfully downloaded ${successCount} image(s)!`, 'success');
            } else {
                showNotification(`Downloaded ${successCount}/${order.items.length} images. ${failCount} failed.`, failCount === order.items.length ? 'error' : 'warning');
            }
        }
        
        // Async version of downloadImage for batch downloads
        function downloadImageAsync(imageData, filename) {
            return new Promise((resolve, reject) => {
                try {
                    const decodedData = decodeURIComponent(imageData);
                    
                    if (decodedData.startsWith('http')) {
                        fetch(decodedData)
                            .then(response => {
                                if (!response.ok) throw new Error('Network response was not ok');
                                return response.blob();
                            })
                            .then(blob => {
                                const url = window.URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = filename;
                                document.body.appendChild(link);
                                link.click();
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(link);
                                resolve();
                            })
                            .catch(reject);
                    } else {
                        let dataUrl = decodedData;
                        if (!dataUrl.startsWith('data:')) {
                            dataUrl = 'data:image/jpeg;base64,' + decodedData;
                        }
                        const link = document.createElement('a');
                        link.href = dataUrl;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        resolve();
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Helper function to download image from button data attributes
        function downloadImageFromData(button) {
            const base64Data = decodeURIComponent(button.getAttribute('data-image-data'));
            const filename = button.getAttribute('data-filename');
            
            console.log(' Download from data attributes triggered');
            console.log(' Filename:', filename);
            console.log(' Decoded data length:', base64Data ? base64Data.length : 'null');
            console.log(' Data preview:', base64Data ? base64Data.substring(0, 50) + '...' : 'null');
            
            downloadImage(base64Data, filename);
        }

        // Helper function to download images (handles both Base64 and Cloudinary URLs)
        function downloadImage(imageData, filename) {
            console.log(' Attempting to download image:', filename);
            console.log(' Image data type:', typeof imageData);
            console.log(' Image data length:', imageData ? imageData.length : 'null/undefined');
            console.log(' Image data preview:', imageData ? imageData.substring(0, 50) + '...' : 'null/undefined');
            
            if (!imageData) {
                alert('No image data available for download');
                console.error(' No image data provided for download');
                return;
            }
            
            try {
                // Decode the URL if it's encoded first to check if it's a URL
                const decodedData = decodeURIComponent(imageData);
                
                // Check if this is a Cloudinary or other HTTP URL
                if (decodedData.startsWith('http')) {
                    console.log(' Detected URL image source - fetching from URL');
                    console.log(' Decoded URL:', decodedData);
                    
                    // For URLs, we need to fetch the image first
                    fetch(decodedData)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            // Create object URL from blob
                            const url = window.URL.createObjectURL(blob);
                            
                            // Create download link
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = filename || 'image.jpg';
                            
                            // Append to body temporarily
                            document.body.appendChild(link);
                            
                            // Trigger download
                            link.click();
                            
                            // Clean up
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(link);
                            
                            console.log(' URL image download completed for:', filename);
                        })
                        .catch(error => {
                            console.error(' Error fetching image from URL:', error);
                            alert('Failed to download image from URL: ' + error.message);
                        });
                    
                    return;
                }
                
                // Handle Base64 data - use the decoded data for consistency
                let dataUrl = decodedData;
                if (!dataUrl.startsWith('data:')) {
                    // If it's just base64 string, add the data URL prefix
                    dataUrl = 'data:image/jpeg;base64,' + decodedData;
                    console.log(' Added data URL prefix to Base64 string');
                }
                
                // Create a temporary link element
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = filename || 'image.jpg';
                
                // Append to body temporarily
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                
                // Clean up
                document.body.removeChild(link);
                
                console.log(' Base64 image download initiated for:', filename);
            } catch (error) {
                console.error(' Error downloading image:', error);
                alert('Failed to download image: ' + error.message);
            }
        }

        // Keep backward compatibility
        function downloadBase64Image(base64Data, filename) {
            downloadImage(base64Data, filename);
        }

        // ============ DELETE ORDER FUNCTIONALITY ============
        
        // Store pending delete info
        let pendingDeleteInfo = null;
        
        function deleteOrder(orderId, orderNumber) {
            // Show confirmation modal for single order delete
            pendingDeleteInfo = {
                type: 'single',
                orderId: orderId,
                orderNumber: orderNumber
            };
            
            document.getElementById('confirm-modal-title').textContent = 'Delete Order?';
            document.getElementById('confirm-modal-message').textContent = 
                `Are you sure you want to delete order #${orderNumber}? This action cannot be undone.`;
            document.getElementById('confirm-delete-modal').classList.add('show');
        }
        
        function closeConfirmModal() {
            document.getElementById('confirm-delete-modal').classList.remove('show');
            pendingDeleteInfo = null;
        }
        
        async function confirmDelete() {
            if (!pendingDeleteInfo) return;
            
            const deleteBtn = document.getElementById('confirm-delete-btn');
            const originalText = deleteBtn.textContent;
            deleteBtn.textContent = 'Deleting...';
            deleteBtn.disabled = true;
            
            try {
                if (pendingDeleteInfo.type === 'single') {
                    await executeSingleDelete(pendingDeleteInfo.orderId, pendingDeleteInfo.orderNumber);
                } else if (pendingDeleteInfo.type === 'bulk') {
                    await executeBulkDelete(pendingDeleteInfo.orderIds, pendingDeleteInfo.source);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete: ' + error.message);
            } finally {
                deleteBtn.textContent = originalText;
                deleteBtn.disabled = false;
                closeConfirmModal();
            }
        }
        
        async function executeSingleDelete(orderId, orderNumber) {
            console.log(' Deleting order:', orderId, orderNumber);
            console.log(' Order ID to delete:', orderId);
            
            if (!window.jbAPI || typeof window.jbAPI.deleteOrder !== 'function') {
                throw new Error('Firebase API not available');
            }
            
            const result = await window.jbAPI.deleteOrder(orderId);
            
            if (result.success) {
                console.log(' Order deleted successfully from Firebase');
                
                // Remove from local arrays using both id and orderId
                const beforeCount = orders.length;
                orders = orders.filter(o => {
                    const orderDocId = o.id || o.orderId;
                    return orderDocId !== orderId;
                });
                console.log(` Orders array: ${beforeCount} -> ${orders.length}`);
                
                filteredOrders = filteredOrders.filter(o => {
                    const orderDocId = o.id || o.orderId;
                    return orderDocId !== orderId;
                });
                
                tabFilteredOrders = tabFilteredOrders.filter(o => {
                    const orderDocId = o.id || o.orderId;
                    return orderDocId !== orderId;
                });
                
                // Update tables and stats
                updateDashboardStats();
                updateRecentOrdersTable();
                updateTabCounts();
                applyTabFilter();
                
                // Show success message
                showNotification(`Order #${orderNumber} deleted successfully`, 'success');
            } else {
                throw new Error(result.error || 'Failed to delete order');
            }
        }
        
        async function executeBulkDelete(orderIds, source) {
            console.log(' Bulk deleting orders:', orderIds.length);
            console.log(' Order IDs to delete:', orderIds);
            
            if (!window.jbAPI || typeof window.jbAPI.deleteMultipleOrders !== 'function') {
                throw new Error('Firebase API not available');
            }
            
            const result = await window.jbAPI.deleteMultipleOrders(orderIds);
            
            if (result.success) {
                console.log(' Orders deleted successfully from Firebase:', result.deletedCount);
                
                // Remove from local arrays
                orders = orders.filter(o => {
                    const orderDocId = o.id || o.orderId;
                    return !orderIds.includes(orderDocId);
                });
                
                filteredOrders = filteredOrders.filter(o => {
                    const orderDocId = o.id || o.orderId;
                    return !orderIds.includes(orderDocId);
                });
                
                tabFilteredOrders = tabFilteredOrders.filter(o => {
                    const orderDocId = o.id || o.orderId;
                    return !orderIds.includes(orderDocId);
                });
                
                // Clear selections
                if (source === 'recent') {
                    selectedRecentOrders.clear();
                    updateRecentBulkActionsBar();
                } else {
                    selectedAllOrders.clear();
                    updateAllBulkActionsBar();
                }
                
                // Update tables and stats
                updateDashboardStats();
                updateRecentOrdersTable();
                updateTabCounts();
                applyTabFilter();
                
                // Show success message
                showNotification(`${result.deletedCount} orders deleted successfully`, 'success');
            } else {
                throw new Error(result.error || 'Failed to delete orders');
            }
        }
        
        // ============ SELECTION FUNCTIONALITY FOR ALL ORDERS ============
        
        function toggleAllOrderSelection(checkbox) {
            const orderId = checkbox.dataset.orderId;
            if (checkbox.checked) {
                selectedAllOrders.add(orderId);
            } else {
                selectedAllOrders.delete(orderId);
            }
            updateAllBulkActionsBar();
            updateAllSelectAllCheckbox();
        }
        
        function toggleSelectAllOrders(checkbox) {
            const checkboxes = document.querySelectorAll('.all-order-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const orderId = cb.dataset.orderId;
                if (checkbox.checked) {
                    selectedAllOrders.add(orderId);
                } else {
                    selectedAllOrders.delete(orderId);
                }
            });
            updateAllBulkActionsBar();
            
            // Sync both select all checkboxes
            const desktopCheckbox = document.getElementById('all-select-all');
            const mobileCheckbox = document.getElementById('mobile-select-all');
            if (desktopCheckbox) desktopCheckbox.checked = checkbox.checked;
            if (mobileCheckbox) mobileCheckbox.checked = checkbox.checked;
        }
        
        function updateAllSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('all-select-all');
            const mobileSelectAllCheckbox = document.getElementById('mobile-select-all');
            const checkboxes = document.querySelectorAll('.all-order-checkbox');
            if (checkboxes.length === 0) return;
            
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
            }
            if (mobileSelectAllCheckbox) {
                mobileSelectAllCheckbox.checked = allChecked;
                mobileSelectAllCheckbox.indeterminate = someChecked && !allChecked;
            }
        }
        
        function updateAllBulkActionsBar() {
            const bar = document.getElementById('all-orders-bulk-actions');
            const countSpan = document.getElementById('all-selected-count');
            if (!bar || !countSpan) return;
            
            const count = selectedAllOrders.size;
            countSpan.textContent = count;
            
            if (count > 0) {
                bar.classList.add('show');
            } else {
                bar.classList.remove('show');
            }
        }
        
        function clearAllOrdersSelection() {
            selectedAllOrders.clear();
            const checkboxes = document.querySelectorAll('.all-order-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            const selectAllCheckbox = document.getElementById('all-select-all');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateAllBulkActionsBar();
        }
        
        function deleteSelectedAllOrders() {
            const count = selectedAllOrders.size;
            if (count === 0) return;
            
            pendingDeleteInfo = {
                type: 'bulk',
                orderIds: Array.from(selectedAllOrders),
                source: 'all'
            };
            
            document.getElementById('confirm-modal-title').textContent = 'Delete Selected Orders?';
            document.getElementById('confirm-modal-message').textContent = 
                `Are you sure you want to delete ${count} order${count > 1 ? 's' : ''}? This action cannot be undone.`;
            document.getElementById('confirm-delete-modal').classList.add('show');
        }
        
        // ============ NOTIFICATION HELPER ============
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 2000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ============ CUSTOMER ANALYTICS FUNCTIONS ============
        
        let customerData = [];
        let showingAllCustomers = false;
        let frameTypesChart = null;
        let customerDistributionChart = null;

        function loadCustomers() {
            console.log('Loading customers analytics...');
            
            // Process orders to extract customer data
            const customerMap = new Map();
            const frameTypeMap = new Map();
            
            orders.forEach(order => {
                const email = order.customer?.email?.toLowerCase() || 'unknown';
                
                if (!customerMap.has(email)) {
                    customerMap.set(email, {
                        email: email,
                        name: order.customer?.name || 'Unknown',
                        phone: order.customer?.phone || 'N/A',
                        orders: [],
                        totalSpent: 0,
                        orderCount: 0
                    });
                }
                
                const customer = customerMap.get(email);
                customer.orders.push(order);
                customer.orderCount++;
                customer.totalSpent += parseFloat(order.totals?.total || 0);
                
                // Update name/phone if available and current is unknown
                if (order.customer?.name && customer.name === 'Unknown') {
                    customer.name = order.customer.name;
                }
                if (order.customer?.phone && customer.phone === 'N/A') {
                    customer.phone = order.customer.phone;
                }
                
                // Track frame types
                if (order.items && order.items.length > 0) {
                    order.items.forEach(item => {
                        const frameSize = item.frameSize?.size || 'Unknown';
                        const frameColor = item.frameColor || 'Unknown';
                        const frameKey = `${frameSize} - ${frameColor}`;
                        frameTypeMap.set(frameKey, (frameTypeMap.get(frameKey) || 0) + 1);
                    });
                }
            });
            
            // Convert to array and sort by order count (descending)
            customerData = Array.from(customerMap.values()).sort((a, b) => b.orderCount - a.orderCount);
            
            // Calculate statistics
            const totalCustomers = customerData.length;
            const repeatCustomers = customerData.filter(c => c.orderCount >= 2);
            const repeatCustomerCount = repeatCustomers.length;
            const ordersFromRepeatCustomers = repeatCustomers.reduce((sum, c) => sum + c.orderCount, 0);
            const repeatPercentage = totalCustomers > 0 ? ((repeatCustomerCount / totalCustomers) * 100).toFixed(1) : 0;
            const repeatOrdersPercentage = orders.length > 0 ? ((ordersFromRepeatCustomers / orders.length) * 100).toFixed(1) : 0;
            const avgOrdersPerCustomer = totalCustomers > 0 ? (orders.length / totalCustomers).toFixed(2) : 0;
            const totalRevenue = customerData.reduce((sum, c) => sum + c.totalSpent, 0);
            const avgOrderValue = orders.length > 0 ? (totalRevenue / orders.length).toFixed(2) : 0;
            
            // Update stats display
            document.getElementById('total-customers-stat').textContent = totalCustomers;
            document.getElementById('repeat-customers-stat').textContent = repeatCustomerCount;
            document.getElementById('repeat-percentage-stat').textContent = `${repeatPercentage}% of customers`;
            document.getElementById('repeat-orders-percentage-stat').textContent = `${repeatOrdersPercentage}% of orders`;
            document.getElementById('customer-total-orders-stat').textContent = orders.length;
            document.getElementById('orders-from-repeat-stat').textContent = `${ordersFromRepeatCustomers} from repeat customers`;
            document.getElementById('avg-orders-stat').textContent = avgOrdersPerCustomer;
            document.getElementById('avg-order-value-stat').textContent = `${parseFloat(avgOrderValue).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            
            // Update top 5 customers table
            updateTopCustomersTable(customerData.slice(0, 5));
            
            // Update all customers table
            updateAllCustomersTable(customerData);
            
            // Render charts
            renderFrameTypesChart(frameTypeMap);
            renderCustomerDistributionChart(customerData);
            
            // Set up search and sort for customers
            setupCustomerSearchAndSort();
        }
        
        function updateTopCustomersTable(customers) {
            const tableBody = document.getElementById('top-customers-table-body');
            if (!tableBody) return;
            
            if (customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">No customers found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = customers.map((customer, index) => {
                const isRepeat = customer.orderCount >= 2;
                const rankIcon = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : `#${index + 1}`;
                
                return `
                <tr class="customer-row">
                    <td class="col-rank"><strong style="font-size: 1.2em;">${rankIcon}</strong></td>
                    <td class="col-email"><strong>${customer.email}</strong></td>
                    <td class="col-name">${customer.name || 'N/A'}</td>
                    <td class="col-phone">${customer.phone || 'N/A'}</td>
                    <td class="col-orders"><span class="badge ${isRepeat ? 'badge-success' : 'badge-info'}">${customer.orderCount} order${customer.orderCount > 1 ? 's' : ''}</span></td>
                    <td class="col-spent"><strong style="color: var(--success);">${customer.totalSpent.toFixed(2)}</strong></td>
                    <td class="col-type">${isRepeat ? '<span class="badge badge-success">Repeat</span>' : '<span class="badge badge-info">New</span>'}</td>
                </tr>
            `}).join('');
        }
        
        function updateAllCustomersTable(customers) {
            const tableBody = document.getElementById('all-customers-table-body');
            if (!tableBody) return;
            
            if (customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">No customers found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = customers.map((customer, index) => {
                const isRepeat = customer.orderCount >= 2;
                
                return `
                <tr class="customer-row">
                    <td class="col-rank"><strong>#${index + 1}</strong></td>
                    <td class="col-email"><strong>${customer.email}</strong></td>
                    <td class="col-name">${customer.name || 'N/A'}</td>
                    <td class="col-phone">${customer.phone || 'N/A'}</td>
                    <td class="col-orders"><span class="badge ${isRepeat ? 'badge-success' : 'badge-info'}">${customer.orderCount} order${customer.orderCount > 1 ? 's' : ''}</span></td>
                    <td class="col-spent"><strong style="color: var(--success);">${customer.totalSpent.toFixed(2)}</strong></td>
                    <td class="col-type">${isRepeat ? '<span class="badge badge-success">Repeat</span>' : '<span class="badge badge-info">New</span>'}</td>
                </tr>
            `}).join('');
        }
        
        function toggleAllCustomers() {
            showingAllCustomers = !showingAllCustomers;
            const allCustomersCard = document.getElementById('all-customers-card');
            const btnText = document.getElementById('view-all-btn-text');
            
            if (showingAllCustomers) {
                allCustomersCard.style.display = 'block';
                btnText.textContent = 'Hide All';
                // Scroll to all customers
                allCustomersCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                allCustomersCard.style.display = 'none';
                btnText.textContent = 'View All';
            }
        }
        
        function setupCustomerSearchAndSort() {
            const searchInput = document.getElementById('customer-search');
            const sortSelect = document.getElementById('customer-sort');
            
            if (searchInput) {
                searchInput.addEventListener('input', filterAndSortCustomers);
            }
            
            if (sortSelect) {
                sortSelect.addEventListener('change', filterAndSortCustomers);
            }
        }
        
        function filterAndSortCustomers() {
            const searchTerm = document.getElementById('customer-search')?.value.toLowerCase() || '';
            const sortOption = document.getElementById('customer-sort')?.value || 'orders-desc';
            
            let filteredCustomers = customerData.filter(customer => {
                return !searchTerm || 
                    customer.email.toLowerCase().includes(searchTerm) ||
                    customer.name.toLowerCase().includes(searchTerm) ||
                    customer.phone.toLowerCase().includes(searchTerm);
            });
            
            // Sort customers
            filteredCustomers.sort((a, b) => {
                switch(sortOption) {
                    case 'orders-asc':
                        return a.orderCount - b.orderCount;
                    case 'email-asc':
                        return a.email.localeCompare(b.email);
                    case 'email-desc':
                        return b.email.localeCompare(a.email);
                    case 'spent-desc':
                        return b.totalSpent - a.totalSpent;
                    case 'spent-asc':
                        return a.totalSpent - b.totalSpent;
                    default: // 'orders-desc'
                        return b.orderCount - a.orderCount;
                }
            });
            
            updateAllCustomersTable(filteredCustomers);
        }
        
        function renderFrameTypesChart(frameTypeMap) {
            const ctx = document.getElementById('frame-types-chart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (frameTypesChart) {
                frameTypesChart.destroy();
            }
            
            // Get top 6 frame types
            const sortedFrameTypes = Array.from(frameTypeMap.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            const labels = sortedFrameTypes.map(([type]) => type);
            const data = sortedFrameTypes.map(([, count]) => count);
            
            const colors = [
                '#6366f1', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6'
            ];
            
            frameTypesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} orders (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerDistributionChart(customers) {
            const ctx = document.getElementById('customer-distribution-chart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (customerDistributionChart) {
                customerDistributionChart.destroy();
            }
            
            // Categorize customers by order count
            const oneOrder = customers.filter(c => c.orderCount === 1).length;
            const twoOrders = customers.filter(c => c.orderCount === 2).length;
            const threeOrders = customers.filter(c => c.orderCount === 3).length;
            const fourPlusOrders = customers.filter(c => c.orderCount >= 4).length;
            
            customerDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1 Order', '2 Orders', '3 Orders', '4+ Orders'],
                    datasets: [{
                        label: 'Number of Customers',
                        data: [oneOrder, twoOrders, threeOrders, fourPlusOrders],
                        backgroundColor: ['#94a3b8', '#10b981', '#f59e0b', '#6366f1'],
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw} customer${context.raw !== 1 ? 's' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // ============ COMPREHENSIVE ANALYTICS FUNCTIONS ============
        
        let revenueOverTimeChart = null;
        let ordersByStatusChart = null;
        let analyticsFrameSizesChart = null;
        let analyticsFrameColorsChart = null;
        let ordersByDayChart = null;

        function loadAnalytics() {
            console.log(' Loading comprehensive analytics...');
            
            if (!orders || orders.length === 0) {
                console.log('No orders to analyze');
                return;
            }
            
            // Calculate all analytics
            const analytics = calculateAnalytics();
            
            // Update stat cards
            updateAnalyticsStats(analytics);
            
            // Render charts
            renderRevenueOverTimeChart(analytics.revenueByDate);
            renderOrdersByStatusChart(analytics.ordersByStatus);
            renderAnalyticsFrameSizesChart(analytics.frameSizes);
            renderAnalyticsFrameColorsChart(analytics.frameColors);
            renderOrdersByDayChart(analytics.ordersByDay);
            
            // Update tables
            updateTopProductsTable(analytics.topProducts);
            updateLocationAnalyticsTable(analytics.locationData);
        }
        
        function calculateAnalytics() {
            const now = new Date();
            const today = now.toDateString();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            
            let totalRevenue = 0;
            let totalItems = 0;
            let monthRevenue = 0;
            let monthOrders = 0;
            let todayRevenue = 0;
            let todayOrders = 0;
            let completedOrders = 0;
            
            const revenueByDate = {};
            const ordersByStatus = { pending: 0, processing: 0, shipped: 0, completed: 0, delivered: 0, cancelled: 0 };
            const frameSizes = {};
            const frameColors = {};
            const productConfigs = {};
            const ordersByDay = { 'Sun': 0, 'Mon': 0, 'Tue': 0, 'Wed': 0, 'Thu': 0, 'Fri': 0, 'Sat': 0 };
            const locationData = {};
            
            orders.forEach(order => {
                const orderTotal = parseFloat(order.totals?.total || 0);
                const orderDate = getOrderDate(order.orderDate);
                const dateKey = orderDate.toISOString().split('T')[0];
                const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][orderDate.getDay()];
                const itemCount = order.items ? order.items.length : (order.quantity || 1);
                
                // Total revenue
                totalRevenue += orderTotal;
                totalItems += itemCount;
                
                // Revenue by date
                revenueByDate[dateKey] = (revenueByDate[dateKey] || 0) + orderTotal;
                
                // Orders by day of week
                ordersByDay[dayName]++;
                
                // This month
                if (orderDate.getMonth() === thisMonth && orderDate.getFullYear() === thisYear) {
                    monthRevenue += orderTotal;
                    monthOrders++;
                }
                
                // Today
                if (orderDate.toDateString() === today) {
                    todayRevenue += orderTotal;
                    todayOrders++;
                }
                
                // Orders by status
                const status = order.status || 'pending';
                ordersByStatus[status] = (ordersByStatus[status] || 0) + 1;
                
                // Completed orders
                if (status === 'completed' || status === 'delivered') {
                    completedOrders++;
                }
                
                // Frame sizes and colors
                if (order.items && order.items.length > 0) {
                    order.items.forEach(item => {
                        const size = item.frameSize?.size || 'Standard';
                        const color = item.frameColor || 'Wood';
                        const texture = item.frameTexture || 'Standard';
                        const price = parseFloat(item.price || 349);
                        
                        // Frame sizes
                        if (!frameSizes[size]) frameSizes[size] = { count: 0, revenue: 0 };
                        frameSizes[size].count++;
                        frameSizes[size].revenue += price;
                        
                        // Frame colors
                        if (!frameColors[color]) frameColors[color] = { count: 0, revenue: 0 };
                        frameColors[color].count++;
                        frameColors[color].revenue += price;
                        
                        // Product configurations
                        const configKey = `${size} - ${color}`;
                        if (!productConfigs[configKey]) productConfigs[configKey] = { count: 0, revenue: 0 };
                        productConfigs[configKey].count++;
                        productConfigs[configKey].revenue += price;
                    });
                }
                
                // Location data - Extract state from address
                const address = order.customer?.address || '';
                let state = 'Unknown';
                
                // List of Indian states for matching
                const indianStates = [
                    'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
                    'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka',
                    'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram',
                    'Nagaland', 'Odisha', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu',
                    'Telangana', 'Tripura', 'Uttar Pradesh', 'Uttarakhand', 'West Bengal',
                    'Delhi', 'Jammu and Kashmir', 'Ladakh', 'Chandigarh', 'Puducherry',
                    'Andaman and Nicobar', 'Dadra and Nagar Haveli', 'Daman and Diu', 'Lakshadweep'
                ];
                
                // Try to find state in address
                const addressLower = address.toLowerCase();
                for (const s of indianStates) {
                    if (addressLower.includes(s.toLowerCase())) {
                        state = s;
                        break;
                    }
                }
                
                // If no state found, try to extract from comma-separated parts
                if (state === 'Unknown') {
                    const addressParts = address.split(',').map(p => p.trim());
                    // Usually format: Street, Locality, City, State, Pincode
                    // State is typically second-to-last before pincode
                    if (addressParts.length >= 2) {
                        // Try second-to-last part (before pincode)
                        const potentialState = addressParts[addressParts.length - 2]?.replace(/\\d+/g, '').trim();
                        if (potentialState && potentialState.length > 2) {
                            state = potentialState;
                        }
                    }
                }
                
                // Use state as key
                if (!locationData[state]) {
                    locationData[state] = { state, orders: 0, revenue: 0 };
                }
                locationData[state].orders++;
                locationData[state].revenue += orderTotal;
            });
            
            // Sort and get top products
            const topProducts = Object.entries(productConfigs)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            
            // Calculate averages
            const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;
            const conversionRate = orders.length > 0 ? (completedOrders / orders.length * 100) : 0;
            
            return {
                totalRevenue,
                totalItems,
                avgOrderValue,
                conversionRate,
                monthRevenue,
                monthOrders,
                todayRevenue,
                todayOrders,
                revenueByDate,
                ordersByStatus,
                frameSizes,
                frameColors,
                topProducts,
                ordersByDay,
                locationData: Object.values(locationData).sort((a, b) => b.orders - a.orders).slice(0, 10)
            };
        }
        
        function updateAnalyticsStats(analytics) {
            document.getElementById('analytics-total-revenue').textContent = 
                '' + analytics.totalRevenue.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('analytics-total-items').textContent = analytics.totalItems.toLocaleString();
            document.getElementById('analytics-avg-order').textContent = 
                '' + analytics.avgOrderValue.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('analytics-conversion-rate').textContent = 
                analytics.conversionRate.toFixed(1) + '%';
            document.getElementById('analytics-month-revenue').textContent = 
                '' + analytics.monthRevenue.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('analytics-month-orders').innerHTML = 
                `<i class="fas fa-shopping-cart"></i><span>${analytics.monthOrders} orders this month</span>`;
            document.getElementById('analytics-today-orders').textContent = analytics.todayOrders;
            document.getElementById('analytics-today-revenue').innerHTML = 
                `<i class="fas fa-rupee-sign"></i><span>${analytics.todayRevenue.toLocaleString('en-IN')} revenue today</span>`;
        }
        
        function renderRevenueOverTimeChart(revenueByDate) {
            const ctx = document.getElementById('revenue-over-time-chart');
            if (!ctx) return;
            
            if (revenueOverTimeChart) revenueOverTimeChart.destroy();
            
            const days = parseInt(document.getElementById('revenue-chart-period')?.value || 30);
            const dates = [];
            const revenues = [];
            
            // Generate last N days
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                dates.push(date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
                revenues.push(revenueByDate[dateKey] || 0);
            }
            
            revenueOverTimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Revenue ()',
                        data: revenues,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.raw.toLocaleString('en-IN')}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => '' + value.toLocaleString('en-IN')
                            }
                        }
                    }
                }
            });
        }
        
        function updateRevenueChart() {
            const analytics = calculateAnalytics();
            renderRevenueOverTimeChart(analytics.revenueByDate);
        }
        
        function renderOrdersByStatusChart(ordersByStatus) {
            const ctx = document.getElementById('orders-by-status-chart');
            if (!ctx) return;
            
            if (ordersByStatusChart) ordersByStatusChart.destroy();
            
            const labels = Object.keys(ordersByStatus).filter(k => ordersByStatus[k] > 0);
            const data = labels.map(k => ordersByStatus[k]);
            const colors = {
                pending: '#f59e0b',
                processing: '#3b82f6',
                shipped: '#8b5cf6',
                completed: '#10b981',
                delivered: '#059669',
                cancelled: '#ef4444'
            };
            
            ordersByStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map(l => colors[l] || '#6b7280'),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { padding: 15, font: { size: 12 } }
                        }
                    }
                }
            });
        }
        
        function renderAnalyticsFrameSizesChart(frameSizes) {
            const ctx = document.getElementById('analytics-frame-sizes-chart');
            if (!ctx) return;
            
            if (analyticsFrameSizesChart) analyticsFrameSizesChart.destroy();
            
            const sorted = Object.entries(frameSizes)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 6);
            
            const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6'];
            
            analyticsFrameSizesChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sorted.map(s => s.name),
                    datasets: [{
                        data: sorted.map(s => s.count),
                        backgroundColor: colors.slice(0, sorted.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { padding: 15, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const item = sorted[context.dataIndex];
                                    return `${item.name}: ${item.count} (${item.revenue.toLocaleString('en-IN')})`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderAnalyticsFrameColorsChart(frameColors) {
            const ctx = document.getElementById('analytics-frame-colors-chart');
            if (!ctx) return;
            
            if (analyticsFrameColorsChart) analyticsFrameColorsChart.destroy();
            
            const sorted = Object.entries(frameColors)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 6);
            
            // Map common color names to actual colors
            const colorMap = {
                'Wood': '#8B4513',
                'Black': '#1f2937',
                'White': '#f3f4f6',
                'Gold': '#d4af37',
                'Silver': '#c0c0c0',
                'Brown': '#964B00',
                'Walnut': '#5C4033',
                'Oak': '#c4a35a'
            };
            
            const chartColors = sorted.map(s => colorMap[s.name] || '#6b7280');
            
            analyticsFrameColorsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s.name),
                    datasets: [{
                        label: 'Units Sold',
                        data: sorted.map(s => s.count),
                        backgroundColor: chartColors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const item = sorted[context.dataIndex];
                                    return `${item.count} units (${item.revenue.toLocaleString('en-IN')})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }
        
        function renderOrdersByDayChart(ordersByDay) {
            const ctx = document.getElementById('orders-by-day-chart');
            if (!ctx) return;
            
            if (ordersByDayChart) ordersByDayChart.destroy();
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const data = days.map(d => ordersByDay[d] || 0);
            
            // Highlight the busiest day
            const maxOrders = Math.max(...data);
            const colors = data.map(d => d === maxOrders && d > 0 ? '#10b981' : '#6366f1');
            
            ordersByDayChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                    datasets: [{
                        label: 'Orders',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }
        
        function updateTopProductsTable(topProducts) {
            const tableBody = document.getElementById('top-products-table-body');
            if (!tableBody) return;
            
            if (topProducts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No data available</td></tr>';
                return;
            }
            
            const rankIcons = ['', '', '', '4', '5'];
            tableBody.innerHTML = topProducts.map((product, index) => `
                <tr>
                    <td data-label="Rank"><strong style="font-size: 1.2em;">${rankIcons[index] || index + 1}</strong></td>
                    <td data-label="Frame"><strong>${product.name}</strong></td>
                    <td data-label="Units Sold"><span class="badge badge-info">${product.count}</span></td>
                    <td data-label="Revenue"><strong style="color: var(--success);">${product.revenue.toLocaleString('en-IN')}</strong></td>
                </tr>
            `).join('');
        }
        
        function updateLocationAnalyticsTable(locationData) {
            const tableBody = document.getElementById('location-analytics-table-body');
            if (!tableBody) return;
            
            // Group by state instead of city
            const stateData = {};
            locationData.forEach(loc => {
                const state = loc.state || 'Unknown';
                if (!stateData[state]) {
                    stateData[state] = { state, orders: 0, revenue: 0 };
                }
                stateData[state].orders += loc.orders;
                stateData[state].revenue += loc.revenue;
            });
            
            const sortedStates = Object.values(stateData).sort((a, b) => b.orders - a.orders).slice(0, 10);
            
            if (sortedStates.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No location data available</td></tr>';
                return;
            }
            
            const rankIcons = ['', '', ''];
            tableBody.innerHTML = sortedStates.map((loc, index) => `
                <tr>
                    <td data-label="Rank"><strong style="font-size: 1.1em;">${rankIcons[index] || '#' + (index + 1)}</strong></td>
                    <td data-label="State"><strong>${loc.state}</strong></td>
                    <td data-label="Orders"><span class="badge badge-info">${loc.orders}</span></td>
                    <td data-label="Revenue"><strong style="color: var(--success);">${loc.revenue.toLocaleString('en-IN')}</strong></td>
                    <td data-label="Avg Order">${(loc.revenue / loc.orders).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                </tr>
            `).join('');
        }

        // Export functions
        function exportData() {
            // Check which view is active and export accordingly
            const customersView = document.getElementById('customers-view');
            if (customersView && customersView.style.display !== 'none') {
                exportCustomersCSV();
            } else {
                exportOrdersCSV();
            }
        }

        function exportCustomersCSV() {
            if (!customerData || customerData.length === 0) {
                alert('No customer data to export');
                return;
            }
            
            // customerData is already sorted by orderCount descending
            const csvContent = [
                ['Rank', 'Email', 'Phone', 'Customer Name', 'Total Orders', 'Total Spent ()', 'Customer Type'].join(','),
                ...customerData.map((customer, index) => [
                    index + 1,
                    `"${customer.email || ''}"`,
                    `"${customer.phone || ''}"`,
                    `"${customer.name || ''}"`,
                    customer.orderCount,
                    customer.totalSpent.toFixed(2),
                    customer.orderCount >= 2 ? 'Repeat Customer' : 'New Customer'
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customers-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportOrdersCSV() {
            if (orders.length === 0) {
                alert('No orders to export');
                return;
            }
            
            const csvContent = [
                ['Order Number', 'Customer Name', 'Email', 'Phone', 'Address', 'Date', 'Status', 'Amount', 'Frame Size', 'Frame Type'].join(','),
                ...orders.map(order => [
                    order.orderNumber,
                    `"${order.customerName || ''}"`,
                    `"${order.email || ''}"`,
                    `"${order.phone || ''}"`,
                    `"${order.address || ''}"`,
                    order.orderDate || '',
                    order.status || '',
                    order.totalAmount || '',
                    order.frameSize || '',
                    order.frameType || ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `orders-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Click outside modal to close
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('order-modal');
            if (e.target === modal) {
                closeOrderModal();
            }
            
            // Close confirmation modal when clicking outside
            const confirmModal = document.getElementById('confirm-delete-modal');
            if (e.target === confirmModal) {
                closeConfirmModal();
            }
        });
    </script>

    <!-- Delete Confirmation Modal -->
    <div class="confirm-modal-overlay" id="confirm-delete-modal">
        <div class="confirm-modal">
            <div class="confirm-modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="confirm-modal-title" id="confirm-modal-title">Delete Order?</h3>
            <p class="confirm-modal-message" id="confirm-modal-message">
                Are you sure you want to delete this order? This action cannot be undone.
            </p>
            <div class="confirm-modal-buttons">
                <button class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn-confirm-delete" id="confirm-delete-btn" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase Integration - Use same approach as other pages -->
    <!-- Firebase v9 SDK - Compatibility Mode -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <!-- Load Firebase client after SDK is loaded -->
    <script src="firebase-client-new.js"></script>
    
    <script>
        // ==================== SUPPORT CHAT FUNCTIONS ====================
        let supportChats = [];
        let filteredChats = [];
        let activeChatId = null;
        let chatMessagesUnsubscribe = null;
        let chatsListUnsubscribe = null;
        let currentChatCategory = 'unread'; // 'unread' or 'all'

        async function loadSupportChats() {
            const chatList = document.getElementById('supportChatList');
            
            // Show loading state
            if (chatList) {
                chatList.innerHTML = `
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading chats...</p>
                    </div>
                `;
            }

            try {
                if (!window.jbAPI) {
                    throw new Error('Firebase API not available');
                }

                const result = await window.jbAPI.getAllSupportChats(null);
                supportChats = result.chats || [];

                // Apply category filter
                filterChatsByCategory(currentChatCategory);

                // Count unread chats for badge
                const unreadCount = supportChats.reduce((sum, chat) => sum + (chat.unreadByAdmin || 0), 0);
                updateSupportBadge(unreadCount);
                updateUnreadTabBadge(unreadCount);

                // Set up real-time listener for chat updates
                if (chatsListUnsubscribe) {
                    chatsListUnsubscribe();
                }
                chatsListUnsubscribe = window.jbAPI.listenForNewChats((updatedChats) => {
                    supportChats = updatedChats;
                    filterChatsByCategory(currentChatCategory);
                    const newUnreadCount = supportChats.reduce((sum, chat) => sum + (chat.unreadByAdmin || 0), 0);
                    updateSupportBadge(newUnreadCount);
                    updateUnreadTabBadge(newUnreadCount);
                });

            } catch (error) {
                console.error('Error loading support chats:', error);
                if (chatList) {
                    chatList.innerHTML = `
                        <div class="empty-state" style="padding: 2rem; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--danger); margin-bottom: 1rem;"></i>
                            <h4>Error loading chats</h4>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        function filterChatsByCategory(category) {
            currentChatCategory = category;
            
            // Update tab active states
            document.getElementById('unreadTab')?.classList.toggle('active', category === 'unread');
            document.getElementById('allTab')?.classList.toggle('active', category === 'all');
            
            if (category === 'unread') {
                filteredChats = supportChats.filter(chat => (chat.unreadByAdmin || 0) > 0);
            } else {
                filteredChats = [...supportChats];
            }
            
            renderChatList(filteredChats);
        }
        
        function updateUnreadTabBadge(count) {
            const badge = document.getElementById('unreadTabBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function renderChatList(chats) {
            const chatList = document.getElementById('supportChatList');
            if (!chatList) return;
            
            if (!chats || chats.length === 0) {
                const emptyMessage = currentChatCategory === 'unread' 
                    ? 'No unread chats. You\'re all caught up!' 
                    : 'No chats yet. Customer messages will appear here.';
                chatList.innerHTML = `
                    <div class="empty-state" style="padding: 2rem; text-align: center;">
                        <i class="fas fa-inbox" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="color: var(--text-muted);">${emptyMessage}</p>
                    </div>
                `;
                return;
            }

            chatList.innerHTML = chats.map(chat => {
                const isActive = activeChatId === chat.id;
                const hasUnread = (chat.unreadByAdmin || 0) > 0;
                const timeStr = chat.lastMessageTime ? formatChatTime(chat.lastMessageTime) : '';
                const initials = getInitials(chat.userName || 'C');
                
                return `
                    <div class="chat-list-item ${isActive ? 'active' : ''} ${hasUnread ? 'unread' : ''}" 
                         onclick="openChat('${chat.id}')">
                        <div class="chat-avatar">${initials}</div>
                        <div class="chat-item-content">
                            <div class="chat-item-header">
                                <span class="chat-user-name">${escapeHtml(chat.userName || 'Customer')}</span>
                                <div class="chat-meta">
                                    <span class="chat-time">${timeStr}</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div class="chat-preview">${escapeHtml(chat.lastMessage || 'No messages yet')}</div>
                                ${hasUnread ? `<span class="chat-unread-badge">${chat.unreadByAdmin}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getInitials(name) {
            if (!name) return 'C';
            const parts = name.trim().split(' ');
            if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
            return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
        }

        async function openChat(chatId) {
            activeChatId = chatId;
            const chat = supportChats.find(c => c.id === chatId);
            if (!chat) return;

            // Highlight active chat in list
            document.querySelectorAll('.chat-list-item').forEach(item => item.classList.remove('active'));
            event?.target?.closest('.chat-list-item')?.classList.add('active');
            
            // Mobile: Show conversation panel, hide list
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                // Push history state so back button works
                history.pushState({ chatOpen: true, chatId: chatId }, '', window.location.href);
                document.getElementById('chatListPanel')?.classList.add('hidden');
                document.getElementById('chatConversationPanel')?.classList.add('active');
            }
            
            // Update mobile header
            document.getElementById('mobileUserName').textContent = chat.userName || 'Customer';
            document.getElementById('mobileUserPhone').textContent = chat.userPhone || '';
            document.getElementById('mobileChatActions').innerHTML = chat.status !== 'closed' ? `
                <button class="btn btn-sm btn-secondary" onclick="closeSupportChat('${chatId}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                    <i class="fas fa-check"></i>
                </button>
            ` : '';
            
            // Hide no-chat-selected, show conversation content
            document.getElementById('noChatSelected').style.display = 'none';
            const conversationContent = document.getElementById('conversationContent');
            conversationContent.style.display = 'flex';
            
            // Update desktop header
            document.getElementById('chatUserName').textContent = chat.userName || 'Customer';
            document.getElementById('chatUserDetails').innerHTML = `
                <i class="fas fa-phone"></i> ${chat.userPhone || 'N/A'} 
                ${chat.userEmail ? ` <i class="fas fa-envelope"></i> ${chat.userEmail}` : ''}
            `;
            document.getElementById('conversationActions').innerHTML = chat.status !== 'closed' ? `
                <button class="btn btn-sm btn-secondary" onclick="closeSupportChat('${chatId}')">
                    <i class="fas fa-check-circle"></i> Close
                </button>
            ` : '<span class="chat-status-badge chat-status-closed">Closed</span>';
            
            // Update input area
            const inputArea = document.getElementById('conversationInput');
            if (chat.status === 'closed') {
                inputArea.innerHTML = `
                    <div style="text-align: center; width: 100%; color: var(--text-muted); padding: 0.5rem;">
                        <i class="fas fa-lock"></i> This conversation is closed
                    </div>
                `;
            } else {
                inputArea.innerHTML = `
                    <input type="text" id="adminMessageInput" placeholder="Type your reply..." 
                           onkeypress="if(event.key==='Enter') sendAdminMessage()">
                    <button onclick="sendAdminMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                `;
            }
            
            // Show loading in messages area
            document.getElementById('conversationMessages').innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading messages...</p>
                </div>
            `;

            // Unsubscribe from previous chat listener
            if (chatMessagesUnsubscribe) {
                chatMessagesUnsubscribe();
            }

            // Load and listen to messages
            try {
                chatMessagesUnsubscribe = await window.jbAPI.getChatMessages(chatId, (messages) => {
                    renderConversationMessages(messages);
                });

                // Mark as read
                await window.jbAPI.markChatAsRead(chatId, 'admin');
                
                // Update chat list to reflect read status
                const chatIndex = supportChats.findIndex(c => c.id === chatId);
                if (chatIndex !== -1) {
                    supportChats[chatIndex].unreadByAdmin = 0;
                }
                filterChatsByCategory(currentChatCategory);
                
                // Update badge
                const unreadCount = supportChats.reduce((sum, chat) => sum + (chat.unreadByAdmin || 0), 0);
                updateSupportBadge(unreadCount);
                updateUnreadTabBadge(unreadCount);
                
            } catch (error) {
                console.error('Error loading chat messages:', error);
                document.getElementById('conversationMessages').innerHTML = `
                    <div class="empty-state" style="padding: 2rem; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                        <p>Error loading messages</p>
                    </div>
                `;
            }
        }
        
        function goBackToList() {
            // Mobile: Show list, hide conversation
            document.getElementById('chatListPanel')?.classList.remove('hidden');
            document.getElementById('chatConversationPanel')?.classList.remove('active');
            activeChatId = null;
            
            // Clear active state from chat list
            document.querySelectorAll('.chat-list-item').forEach(item => item.classList.remove('active'));
        }
        
        // Handle browser back button to close chat and go back to list
        window.addEventListener('popstate', function(event) {
            const isMobile = window.innerWidth <= 768;
            const chatPanel = document.getElementById('chatConversationPanel');
            
            if (isMobile && chatPanel?.classList.contains('active')) {
                // We're in a chat view, go back to list
                goBackToList();
            }
        });

        function renderConversationMessages(messages) {
            const container = document.getElementById('conversationMessages');
            if (!container) return;

            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 2rem; text-align: center; background: transparent;">
                        <i class="fas fa-comments" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                        <p style="color: var(--text-muted);">No messages yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => `
                <div class="message-bubble ${msg.senderType}">
                    <div class="message-text">${escapeHtml(msg.text)}</div>
                    <div class="message-time">
                        ${msg.createdAt ? formatChatTime(msg.createdAt) : ''}
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        async function sendAdminMessage() {
            if (!activeChatId) return;
            
            const input = document.getElementById('adminMessageInput');
            if (!input) return;

            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.disabled = true;

            try {
                await window.jbAPI.sendChatMessage(activeChatId, message, 'admin', 'JB Creations Support');
            } catch (error) {
                console.error('Error sending message:', error);
                input.value = message; // Restore message on error
                alert('Failed to send message. Please try again.');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        async function closeSupportChat(chatId) {
            if (!confirm('Close this conversation?')) {
                return;
            }

            try {
                await window.jbAPI.closeSupportChat(chatId);
                
                // On mobile, go back to list
                if (window.innerWidth <= 768) {
                    goBackToList();
                }
                
                // Reload chats
                loadSupportChats();
                
                // Reset conversation panel on desktop
                if (window.innerWidth > 768) {
                    document.getElementById('noChatSelected').style.display = 'flex';
                    document.getElementById('conversationContent').style.display = 'none';
                }
                activeChatId = null;
                
            } catch (error) {
                console.error('Error closing chat:', error);
                alert('Failed to close chat. Please try again.');
            }
        }

        function updateSupportBadge(count) {
            // Update sidebar badge
            const badge = document.getElementById('supportChatBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            // Update mobile nav badge
            const mobileBadge = document.getElementById('mobileNavSupportBadge');
            if (mobileBadge) {
                if (count > 0) {
                    mobileBadge.textContent = count > 99 ? '99+' : count;
                    mobileBadge.style.display = 'flex';
                } else {
                    mobileBadge.style.display = 'none';
                }
            }
        }

        function formatChatTime(date) {
            if (!date) return '';
            const d = date instanceof Date ? date : new Date(date);
            const now = new Date();
            const diffMs = now - d;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Manual cleanup function for old chats
        async function cleanupOldChatsManual() {
            if (!confirm('This will permanently delete all chats older than 15 days. Are you sure?')) {
                return;
            }
            
            try {
                if (!window.jbAPI) {
                    alert('Firebase API not available. Please refresh the page.');
                    return;
                }
                
                const result = await window.jbAPI.cleanupOldChats(15);
                
                if (result.success) {
                    if (result.deletedCount > 0) {
                        alert(`Successfully deleted ${result.deletedCount} old chat(s).`);
                        loadSupportChats();
                    } else {
                        alert('No chats older than 15 days found.');
                    }
                } else {
                    alert('Error cleaning up chats: ' + result.error);
                }
            } catch (error) {
                console.error('Error cleaning up chats:', error);
                alert('Error cleaning up chats: ' + error.message);
            }
        }

        // ==================== END SUPPORT CHAT FUNCTIONS ====================

        // Firebase integration - wait for Firebase to be ready then load data
        let firebaseInitialized = false;

        // Wait for Firebase ready event (same as other pages)
        document.addEventListener('firebaseReady', async () => {
            console.log(' Firebase ready for admin panel');
            firebaseInitialized = true;
            
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData();
            }
        });

        // Fallback initialization - check for window.jbAPI
        setTimeout(async () => {
            if (!firebaseInitialized && window.jbAPI) {
                console.log(' Firebase API fallback initialization');
                firebaseInitialized = true;
                
                if (typeof loadDashboardData === 'function') {
                    await loadDashboardData();
                }
            }
        }, 3000);
        
        // Try to load data when page loads (in case Firebase is already ready)
        document.addEventListener('DOMContentLoaded', async () => {
            setTimeout(async () => {
                if (window.jbAPI && typeof loadDashboardData === 'function') {
                    console.log(' Loading data on page ready');
                    await loadDashboardData();
                }
            }, 1000);
        });
    </script>
    
    <!-- Include Cloudinary configuration for image handling -->
    <script src="cloudinary-config.js"></script>
</body>
</html>
